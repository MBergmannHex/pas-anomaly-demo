<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm Analyzer Pro v5 - AI Enhanced</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>

    <script src="services/stats-service.js"></script>
    <script src="services/data-service.js"></script>
    <script src="services/session-service.js"></script>
    <script src="services/process-mining-service.js"></script>
    <script src="services/rationalization-service.js"></script>
    <script src="services/ml-service.js"></script>
    <script src="services/control-loop-service.js"></script>
    <script src="services/chatbot-service.js"></script>
    <script src="services/dr-processor.js?v=6"></script>

    <!-- API configuration now handled server-side -->

    <style>
        /* Additional styles for chatbot and insights */
        .chat-container {
            height: calc(100vh - 180px);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9fafb;
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.assistant {
            align-items: flex-start;
        }

        .chat-message-content {
            max-width: 90%;
            /* Increased width for better readability */
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            line-height: 1.5;
        }

        .chat-message.user .chat-message-content {
            background-color: #667eea;
            color: white;
        }

        .chat-message.assistant .chat-message-content {
            background-color: white;
            border: 1px solid #e5e7eb;
        }

        .chat-input-container {
            padding: 1rem;
            background-color: white;
            border-top: 1px solid #e5e7eb;
        }

        .chat-suggestions {
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
        }

        .suggestion-chip {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Thought Process Styles */
        .thought-process-container {
            max-width: 90%;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            overflow: hidden;
        }

        .thought-header {
            padding: 0.5rem 1rem;
            background-color: #f1f5f9;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .thought-header:hover {
            background-color: #e2e8f0;
        }

        .thought-content {
            padding: 0.75rem;
            font-size: 0.85rem;
            color: #334155;
            border-top: 1px solid #e5e7eb;
            background-color: white;
        }

        .thought-step {
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 2px solid #cbd5e1;
            position: relative;
        }

        .thought-step:last-child {
            margin-bottom: 0;
        }

        .thought-step::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #cbd5e1;
        }

        .thought-step.intent::before {
            background-color: #8b5cf6;
        }

        /* Purple */
        .thought-step.plan::before {
            background-color: #3b82f6;
        }

        /* Blue */
        .thought-step.action::before {
            background-color: #f59e0b;
        }

        /* Amber */
        .thought-step.observation::before {
            background-color: #10b981;
        }

        /* Green */
        .thought-step.synthesis::before {
            background-color: #ec4899;
        }

        /* Pink */

        .thought-label {
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            display: block;
            letter-spacing: 0.05em;
        }

        .thought-step.intent .thought-label {
            color: #7c3aed;
        }

        .thought-step.plan .thought-label {
            color: #2563eb;
        }

        .thought-step.action .thought-label {
            color: #d97706;
        }

        .thought-step.observation .thought-label {
            color: #059669;
        }

        .thought-step.synthesis .thought-label {
            color: #db2777;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #e5e7eb;
            border-radius: 1rem;
        }

        .typing-indicator span {
            height: 0.5rem;
            width: 0.5rem;
            background-color: #6b7280;
            border-radius: 50%;
            display: inline-block;
            margin: 0 0.1rem;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-0.5rem);
            }
        }

        /* Insight Card & Modal Styles */
        .insight-card {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .insight-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            color: #1e40af;
        }

        .insight-card-title {
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .insight-card-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #93c5fd;
            cursor: pointer;
        }

        .insight-card-close:hover {
            color: #1e40af;
        }

        /* Help Modal */
        .help-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .help-modal {
            background: white;
            border-radius: 0.5rem;
            max-width: 40rem;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .help-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
        }

        .help-modal-content {
            padding: 1.5rem;
        }

        .help-modal-footer {
            padding: 1rem 1.5rem;
            background-color: #f8fafc;
            border-top: 1px solid #e5e7eb;
            text-align: right;
        }

        .help-section {
            margin-bottom: 1.5rem;
        }

        .help-section h4 {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .help-section h4 i {
            margin-right: 0.5rem;
            color: #6366f1;
        }

        .help-section p {
            color: #475569;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .help-section ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            color: #475569;
            font-size: 0.95rem;
        }

        .help-section li {
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">

        // --- NEW COMPONENT: ThoughtProcess ---
        const ThoughtProcess = ({ thoughts }) => {
            const [isOpen, setIsOpen] = React.useState(false);

            if (!thoughts || thoughts.length === 0) return null;

            const displayThoughts = thoughts.filter(t => t.stage !== 'direct_response');
            if (displayThoughts.length === 0) return null;

            return (
                <div className="thought-process-container">
                    <div className="thought-header" onClick={() => setIsOpen(!isOpen)}>
                        <div className="flex items-center">
                            <i className="fas fa-brain mr-2 text-purple-500"></i>
                            <span>AI Reasoning Process ({displayThoughts.length} steps)</span>
                        </div>
                        <i className={`fas fa-chevron-${isOpen ? 'up' : 'down'}`}></i>
                    </div>

                    {isOpen && (
                        <div className="thought-content">
                            {displayThoughts.map((step, idx) => (
                                <div key={idx} className={`thought-step ${step.stage}`}>
                                    <span className="thought-label">{step.stage}</span>
                                    <div className="text-gray-700 text-sm">{step.text}</div>
                                    {step.details && (
                                        <pre className="mt-2 text-xs bg-gray-50 p-2 rounded border border-gray-200 overflow-x-auto text-gray-600">
                                            {JSON.stringify(step.details, null, 2)}
                                        </pre>
                                    )}
                                    {step.data && typeof step.data === 'string' && (
                                        <div className="mt-1 text-xs text-gray-500 italic border-l-2 border-gray-200 pl-2">
                                            Result: {step.data}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW COMPONENT: InsightCard ---
        const InsightCard = ({ title, icon, children, onClose, onMoreInfo }) => {
            return (
                <div className="insight-card">
                    <div className="insight-card-close" onClick={onClose}>
                        <i className="fas fa-times"></i>
                    </div>
                    <div className="insight-card-header">
                        <i className={`fas ${icon} text-xl`}></i>
                        <span className="insight-card-title">{title}</span>
                    </div>
                    <div className="text-sm text-blue-900">
                        {children}
                    </div>
                    {onMoreInfo && (
                        <button onClick={onMoreInfo} className="mt-2 text-xs font-semibold text-blue-600 hover:text-blue-800 flex items-center">
                            <i className="fas fa-book-open mr-1"></i> Learn more
                        </button>
                    )}
                </div>
            );
        };

        // --- NEW COMPONENT: HelpModal ---
        const HelpModal = ({ isOpen, onClose, title, content }) => {
            if (!isOpen) return null;

            return (
                <div className="help-modal-overlay" onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                    <div className="help-modal">
                        <div className="help-modal-header">
                            <h3 className="text-xl font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div className="help-modal-content">
                            {content}
                        </div>
                        <div className="help-modal-footer">
                            <button onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Main Application Component
        const AlarmAnalyzerApp = () => {
            // --- STATE MANAGEMENT ---
            // Raw Data & Sessions
            const [data, setData] = React.useState(null);
            const [sessions, setSessions] = React.useState([]);
            const [validSessions, setValidSessions] = React.useState([]);
            const [unitStats, setUnitStats] = React.useState([]);
            const [unitColumnLabel, setUnitColumnLabel] = React.useState('Unit');
            const [unitColumnLabelPlural, setUnitColumnLabelPlural] = React.useState('Units');

            // Analysis Results
            const [statistics, setStatistics] = React.useState(null);
            const [processVariants, setProcessVariants] = React.useState([]);
            const [nuisanceAlarms, setNuisanceAlarms] = React.useState([]);
            const [alarmHealthMetrics, setAlarmHealthMetrics] = React.useState(null);

            // ML Model
            const [model, setModel] = React.useState(null);
            const [modelStatus, setModelStatus] = React.useState('untrained');
            const [trainingEpochs, setTrainingEpochs] = React.useState(20);
            const [trainingProgress, setTrainingProgress] = React.useState({ epoch: 0, totalEpochs: 20 });

            // Chatbot State
            const [chatMessages, setChatMessages] = React.useState([]);
            const [chatInput, setChatInput] = React.useState('');
            const [isTyping, setIsTyping] = React.useState(false);
            const [chatbotConfigured, setChatbotConfigured] = React.useState(false);
            const [selectedChatSession, setSelectedChatSession] = React.useState(null);
            const [chatbotSettings, setChatbotSettings] = React.useState(() => ({
                apiKey: localStorage.getItem('chatbotApiKey') || '',
                endpoint: localStorage.getItem('chatbotEndpoint') || '',
                deploymentName: localStorage.getItem('chatbotDeploymentName') || 'gpt-4', // Legacy
                generalDeploymentName: localStorage.getItem('chatbotGeneralDeploymentName') || localStorage.getItem('chatbotDeploymentName') || 'gpt-4.1',
                drDeploymentName: localStorage.getItem('chatbotDrDeploymentName') || 'gpt-5.2',
                apiVersion: localStorage.getItem('chatbotApiVersion') || '2024-12-01-preview',
                reasoningEffort: localStorage.getItem('chatbotReasoningEffort') || 'low'
            }));

            // Theme & Settings Panel State
            const [appTheme, setAppTheme] = React.useState(() => {
                return localStorage.getItem('appTheme') || 'light';
            });
            const [showSettings, setShowSettings] = React.useState(false);

            // UI & Interaction State
            const [activeTab, setActiveTab] = React.useState('overview');
            const [appMode, setAppMode] = React.useState('landing'); // 'landing' | 'analysis' | 'rationalization'
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [queryInput, setQueryInput] = React.useState('');
            const [predictionResults, setPredictionResults] = React.useState(null);
            const [rationalizationDecisions, setRationalizationDecisions] = React.useState({});

            // Column mapping state
            const [showColumnMapping, setShowColumnMapping] = React.useState(false);
            const [columnAnalysis, setColumnAnalysis] = React.useState(null);
            const [rawCsvData, setRawCsvData] = React.useState(null);
            const [uploadedFileName, setUploadedFileName] = React.useState('');

            // Insight Cards State
            const [showProcessInsight, setShowProcessInsight] = React.useState(true);
            const [showRationalizationInsight, setShowRationalizationInsight] = React.useState(true);
            const [showStatsInsight, setShowStatsInsight] = React.useState(true);

            // Help Modal State
            const [helpModalOpen, setHelpModalOpen] = React.useState(false);
            const [helpModalContent, setHelpModalContent] = React.useState({ title: '', body: null });

            // Process Mining State
            const [processFilters, setProcessFilters] = React.useState({
                timeRange: { start: null, end: null },
                selectedSession: null,
                startingAlarm: '',
                containsAlarm: '',
                unit: 'all',
                maxNodes: 50,
                minFrequency: 0.02
            });
            const [heuristicFilters, setHeuristicFilters] = React.useState({
                dependencyThreshold: 0.5,
                frequencyThreshold: 0.02,
                showLoops: true,
                showParallel: true
            });
            const [filteredProcessGraph, setFilteredProcessGraph] = React.useState(null);
            const [dfgData, setDfgData] = React.useState(null);
            const [processStats, setProcessStats] = React.useState(null);
            const [needsProcessUpdate, setNeedsProcessUpdate] = React.useState(false);

            // Session filters
            const [sessionFilters, setSessionFilters] = React.useState({
                unit: 'all',
                minDuration: 0,
                minAlarms: 0,
                containsAlarm: ''
            });

            // Pagination
            const [sessionPage, setSessionPage] = React.useState(0);
            const [variantPage, setVariantPage] = React.useState(0);
            const [rationalizationPage, setRationalizationPage] = React.useState(0);
            const ITEMS_PER_PAGE = 10;

            // Refs
            const fileInputRef = React.useRef(null);
            const networkRef = React.useRef(null);
            const networkContainerRef = React.useRef(null);
            const pm4jsRef = React.useRef(null);
            const hourlyChartRef = React.useRef(null);
            const startingEventChartRef = React.useRef(null);
            const alarmFrequencyChartRef = React.useRef(null);
            const nuisanceScoreChartRef = React.useRef(null);
            const unitStatsChartRef = React.useRef(null);
            const networkInstanceRef = React.useRef(null);
            const hourlyChartInstanceRef = React.useRef(null);
            const startingEventChartInstanceRef = React.useRef(null);
            const alarmFrequencyChartInstanceRef = React.useRef(null);
            const nuisanceScoreChartInstanceRef = React.useRef(null);
            const unitStatsChartInstanceRef = React.useRef(null);
            const chatMessagesEndRef = React.useRef(null);


            // --- EDUCATIONAL CONTENT ---
            const helpSystem = {
                processMining: {
                    title: "Understanding Process Mining",
                    body: (
                        <div>
                            <div className="help-section">
                                <h4><i className="fas fa-project-diagram"></i> What is Process Mining?</h4>
                                <p>Process Mining is an analytical discipline that discovers, monitors, and improves real processes by extracting knowledge from event logs. In the context of Alarm Management, it visualizes the sequence of alarms and operator actions as a flow chart.</p>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-microchip"></i> The Heuristic Miner Algorithm</h4>
                                <p>This application uses a <strong>Heuristic Miner</strong>. Unlike simple sequence mapping, it calculates a "Dependency Matrix" to distinguish between causality and coincidence.</p>
                                <ul>
                                    <li><strong>Frequency:</strong> How often event B follows event A.</li>
                                    <li><strong>Dependency Measure:</strong> A score (0 to 1) indicating how likely A <em>causes</em> B. If A is followed by B, but B is rarely followed by A, the dependency is high.</li>
                                </ul>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-eye"></i> Reading the Graph</h4>
                                <ul>
                                    <li><strong>Nodes (Boxes):</strong> Alarms (Orange) or Operator Actions (Blue).</li>
                                    <li><strong>Edges (Arrows):</strong> The flow of the process. Thicker arrows mean higher frequency. Darker arrows mean stronger causal dependency.</li>
                                    <li><strong>Numbers:</strong> The count of times this path was taken.</li>
                                </ul>
                            </div>
                        </div>
                    )
                },
                kpi: {
                    title: "ISA 18.2 Performance Metrics",
                    body: (
                        <div>
                            <div className="help-section">
                                <h4><i className="fas fa-ruler-combined"></i> Alarm System Performance</h4>
                                <p>We strictly follow the <strong>ISA 18.2 / IEC 62682</strong> standards for alarm management.</p>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-tachometer-alt"></i> Average Alarm Rate</h4>
                                <p>The number of alarms an operator handles per 10 minutes. The target is <strong>&le; 1</strong> (manageable). Rates &gt; 2 are considered unmanageable and likely to lead to missed critical events.</p>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-water"></i> Alarm Flood</h4>
                                <p>A condition where the operator receives more alarms than they can effectively process (typically &gt;10 alarms in 10 minutes). The standard requires the system to be in flood <strong>&lt; 1%</strong> of the time.</p>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-comments"></i> Chattering Alarms</h4>
                                <p>An alarm that repeatedly transitions between active and normal states in a short period. This app defines chatter as <strong>3+ activations in 60 seconds</strong>. These are nuisance alarms and should be eliminated.</p>
                            </div>
                        </div>
                    )
                },
                rationalization: {
                    title: "Alarm Rationalization Logic",
                    body: (
                        <div>
                            <div className="help-section">
                                <h4><i className="fas fa-filter"></i> What is Rationalization?</h4>
                                <p>The systematic process of reviewing alarms to ensure they are necessary, distinct, and actionable. We automate the initial assessment using a scoring engine.</p>
                            </div>
                            <div className="help-section">
                                <h4><i className="fas fa-calculator"></i> The Nuisance Score Formula</h4>
                                <p>We calculate a score from 0 (Good) to 100 (Bad) based on 4 weighted factors:</p>
                                <ul>
                                    <li><strong>No Action Score (30%):</strong> Heavily penalizes alarms that operators ignore (&lt; 5% response rate). If an operator never acts, the alarm is likely information only.</li>
                                    <li><strong>Chatter Score (25%):</strong> Penalizes alarms that activate rapidly (&gt;3 times/min).</li>
                                    <li><strong>Flood Score (25%):</strong> Penalizes alarms that contribute to flood periods.</li>
                                    <li><strong>Sequential Score (20%):</strong> Penalizes "Consequential Alarms"â€”those that always happen after another alarm and provide no new information.</li>
                                </ul>
                            </div>
                        </div>
                    )
                }
            };

            const openHelp = (topic) => {
                setHelpModalContent(helpSystem[topic]);
                setHelpModalOpen(true);
            };

            // --- DATA LOADING & PROCESSING ---
            React.useEffect(() => {
                handleLoadModel();
                window.chatbotService.initialize();
                const configured = window.chatbotService.isConfigured();
                setChatbotConfigured(configured);

                if (configured) {
                    // Update state with loaded config - ensure ALL fields are synced
                    setChatbotSettings(prev => ({
                        ...prev,
                        apiKey: window.chatbotService.config.apiKey,
                        endpoint: window.chatbotService.config.endpoint,
                        deploymentName: window.chatbotService.config.deploymentName,
                        generalDeploymentName: window.chatbotService.config.generalDeploymentName || window.chatbotService.config.deploymentName,
                        drDeploymentName: window.chatbotService.config.drDeploymentName,
                        apiVersion: window.chatbotService.config.apiVersion,
                        reasoningEffort: window.chatbotService.config.reasoningEffort || 'medium'
                    }));
                }
                setChatMessages([]);
            }, []);

            React.useEffect(() => {
                chatMessagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages]);

            const formatColumnName = (name) => {
                if (!name || name.toLowerCase() === 'unit') return 'Unit';
                return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsProcessing(true);
                setUploadedFileName(file.name);

                try {
                    const parseResult = await window.dataService.parseCsvFile(file);
                    const analysis = window.dataService.analyzeColumns(parseResult.headers, parseResult.data.slice(0, 10));

                    setRawCsvData(parseResult.data);
                    setColumnAnalysis(analysis);

                    setShowColumnMapping(true);
                    setIsProcessing(false);
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert('Failed to parse CSV file: ' + error.message);
                    setIsProcessing(false);
                }
            };

            const processDataWithMappings = async (rawData, mappings) => {
                setIsProcessing(true);
                try {
                    const formattedUnitLabel = formatColumnName(mappings.unit);
                    setUnitColumnLabel(formattedUnitLabel);
                    setUnitColumnLabelPlural(formattedUnitLabel.endsWith('s') ? formattedUnitLabel : formattedUnitLabel + 's');

                    const cleanData = await window.dataService.processDataWithMappings(rawData, mappings);
                    setData(cleanData);

                    const allSessions = window.sessionService.extractSessions(cleanData);
                    setSessions(allSessions);

                    const validSessionsFiltered = allSessions;
                    setValidSessions(validSessionsFiltered);
                    const selectedDescColumns = window.dataService.getCurrentMappings().descriptiveColumns;
                    window.chatbotService.setSessionData(validSessionsFiltered, selectedDescColumns);

                    const unitStatistics = window.sessionService.getUnitStatistics(allSessions);
                    setUnitStats(unitStatistics);

                    const stats = window.statsService.calculateStatistics(cleanData, validSessionsFiltered);
                    setStatistics(stats);

                    const nuisanceAnalysis = window.rationalizationService.analyzeNuisanceAlarms(cleanData, validSessionsFiltered, allSessions);
                    setNuisanceAlarms(nuisanceAnalysis.alarms);
                    setAlarmHealthMetrics(nuisanceAnalysis.metrics);

                    const variants = window.processMiningService.discoverProcessVariants(validSessionsFiltered);
                    setProcessVariants(variants);

                    if (cleanData.length > 0) {
                        setProcessFilters(prev => ({
                            ...prev,
                            timeRange: { start: cleanData[0].timestamp, end: cleanData[cleanData.length - 1].timestamp }
                        }));
                    }

                    if (chatbotConfigured) {
                        setChatMessages(prev => [...prev, {
                            id: Date.now(),
                            role: 'assistant',
                            content: `Great! I've loaded ${validSessionsFiltered.length} sessions with ${cleanData.length} events. I can see alarm descriptions and patterns. What would you like to know?`,
                            timestamp: new Date()
                        }]);
                    }

                    setShowColumnMapping(false);
                    setRawCsvData(null);
                } catch (error) {
                    console.error('Error processing data:', error);
                    alert('Failed to process data: ' + error.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleConfirmMapping = () => {
                const mappings = window.dataService.getCurrentMappings();
                const validation = window.dataService.validateMappings(mappings);

                if (!validation.isValid) {
                    alert('Please map all required columns:\n' + validation.errors.join('\n'));
                    return;
                }

                processDataWithMappings(rawCsvData, mappings);
            };

            // --- NEW COMPONENT: DrWizard ---
            const DrWizard = ({ onDataLoaded, isActive, data, availableUnits }) => {
                const [step, setStep] = React.useState(1);
                const [files, setFiles] = React.useState({
                    philosophy: null,
                    safety: null,
                    notes: null
                });
                const [scope, setScope] = React.useState({
                    unit: 'All',
                    startDate: '',
                    endDate: ''
                });
                const [progress, setProgress] = React.useState({
                    status: 'idle',
                    percent: 0,
                    currentAction: 'Waiting for input...',
                    logs: []
                });
                const [results, setResults] = React.useState(null);

                const addLog = (msg) => {
                    setProgress(prev => ({
                        ...prev,
                        logs: [...prev.logs, `[${new Date().toLocaleTimeString()}] ${msg}`]
                    }));
                };

                const handleFileChange = (type, e) => {
                    setFiles(prev => ({ ...prev, [type]: e.target.files[0] }));
                };

                const handleStartProcessing = async () => {
                    if (!files.philosophy) {
                        alert("Please upload the Alarm Philosophy.");
                        return;
                    }
                    if (!data || data.length === 0) {
                        alert("No data loaded in the application. Please upload a CSV in Step 1.");
                        return;
                    }

                    setStep(3);
                    setProgress({ status: 'running', percent: 0, currentAction: 'Initializing...', logs: [] });

                    try {
                        // 1. Parse Philosophy
                        addLog("Reading Alarm Philosophy...");
                        const philosophyText = await window.dataService.readFileAsText(files.philosophy);
                        setProgress(prev => ({ ...prev, percent: 10, currentAction: 'Extracting Rules...' }));

                        const philosophyRules = await window.chatbotService.extractPhilosophyRules(philosophyText);
                        addLog(`Extracted ${philosophyRules.priority_matrix?.length || 0} priority rules.`);

                        // 2. Parse Safety Info (Optional)
                        let safetyContext = [];
                        if (files.safety) {
                            addLog("Reading Safety Information...");
                            const safetyText = await window.dataService.readFileAsText(files.safety);
                            setProgress(prev => ({ ...prev, percent: 20, currentAction: 'Enriching Safety Context...' }));
                            safetyContext = await window.chatbotService.enrichWithSafetyData([], safetyText); // Pass empty list initially, or logic to extract all tags
                            addLog(`Found safety context for ${safetyContext.length} tags.`);
                        }

                        // 3. Filter Data by Scope
                        addLog("Filtering Data Scope...");
                        let filteredData = data;
                        if (scope.unit !== 'All') {
                            // Assuming 'Unit' is the column name, adjust if needed based on parsing logic
                            // The data service parsing usually normalizes headers, but let's check a few common ones or use the raw row if needed.
                            // However, the main app uses 'Unit' (capitalized) in unitStats.
                            // Let's filter safely.
                            filteredData = data.filter(row => row['Unit'] === scope.unit || row['unit'] === scope.unit);
                            addLog(`Filtered to Unit: ${scope.unit}`);
                        }

                        // Date filtering could be added here if needed, but Unit is the primary request.

                        addLog(`Processing ${filteredData.length} events (from ${data.length} total).`);
                        setProgress(prev => ({ ...prev, percent: 30, currentAction: 'Analyzing Data...' }));

                        // 4. Run Rationalization Engine
                        const updateProgress = (pct, action) => {
                            setProgress(prev => ({ ...prev, percent: 30 + (pct * 0.6), currentAction: action }));
                        };

                        const rationalizedData = await window.rationalizationService.runAutonomousRationalization(
                            philosophyRules,
                            safetyContext,
                            filteredData,
                            updateProgress
                        );

                        setResults({
                            ...rationalizedData,
                            philosophyRules,
                            safetyContext
                        });
                        setProgress(prev => ({ ...prev, percent: 100, status: 'complete', currentAction: 'Processing Complete!' }));
                        setStep(4);
                        addLog("Rationalization complete.");

                    } catch (error) {
                        console.error(error);
                        addLog(`ERROR: ${error.message}`);
                        setProgress(prev => ({ ...prev, status: 'error', currentAction: 'Failed' }));
                    }
                };

                if (!isActive) return null;

                return (
                    <div className="card">
                        <h2 className="text-2xl font-bold mb-4 text-gray-800">Autonomous D&R Wizard</h2>

                        {/* Stepper Header */}
                        <div className="flex items-center mb-8">
                            {[1, 2, 3, 4].map(s => (
                                <div key={s} className={`flex items-center ${s < 4 ? 'flex-1' : ''}`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${step >= s ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                        {s}
                                    </div>
                                    {s < 4 && <div className={`h-1 flex-1 mx-2 ${step > s ? 'bg-indigo-600' : 'bg-gray-200'}`}></div>}
                                </div>
                            ))}
                        </div>

                        {/* Step 1: Configuration */}
                        {step === 1 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold">Step 1: Configuration Upload</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors">
                                        <i className="fas fa-book text-4xl text-indigo-400 mb-2"></i>
                                        <p className="font-medium">Alarm Philosophy (PDF/Text)</p>
                                        <p className="text-sm text-gray-500 mb-4">Required. Defines priority rules.</p>
                                        <input type="file" onChange={(e) => handleFileChange('philosophy', e)} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
                                    </div>
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-500 transition-colors">
                                        <i className="fas fa-shield-alt text-4xl text-green-400 mb-2"></i>
                                        <p className="font-medium">Process Safety / HAZOP (PDF/Text)</p>
                                        <p className="text-sm text-gray-500 mb-4">Optional. Enriches consequences.</p>
                                        <input type="file" onChange={(e) => handleFileChange('safety', e)} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />
                                    </div>
                                </div>
                                <div className="flex justify-end">
                                    <button onClick={() => setStep(2)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Next: Data Scope <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {/* Step 2: Data Scope */}
                        {step === 2 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold">Step 2: Data Scope</h3>

                                <div className="bg-blue-50 border-l-4 border-blue-500 p-4">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <i className="fas fa-database text-blue-500"></i>
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-blue-700">
                                                Using currently loaded dataset.
                                            </p>
                                            <p className="text-lg font-bold text-blue-800">
                                                {data ? data.length.toLocaleString() : 0} Total Events
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Filter by Unit</label>
                                        <select
                                            className="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                            value={scope.unit}
                                            onChange={(e) => setScope({ ...scope, unit: e.target.value })}
                                        >
                                            <option value="All">All Units</option>
                                            {availableUnits && availableUnits.map(u => (
                                                <option key={u} value={u}>{u}</option>
                                            ))}
                                        </select>
                                        <p className="mt-2 text-sm text-gray-500">Select a specific unit to rationalize, or process the entire facility.</p>
                                    </div>
                                </div>

                                <div className="flex justify-between">
                                    <button onClick={() => setStep(1)} className="text-gray-600 hover:text-gray-900">Back</button>
                                    <button onClick={handleStartProcessing} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Start Auto-Pilot <i className="fas fa-magic ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {/* Step 3: Processing */}
                        {step === 3 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold">Step 3: Processing</h3>
                                <div className="w-full bg-gray-200 rounded-full h-4">
                                    <div className="bg-indigo-600 h-4 rounded-full transition-all duration-500" style={{ width: `${progress.percent}%` }}></div>
                                </div>
                                <p className="text-center font-medium text-indigo-600">{progress.currentAction}</p>

                                <div className="bg-gray-900 text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm" id="dr-logs">
                                    {progress.logs.map((log, i) => (
                                        <div key={i}>{log}</div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Step 4: Review & Export */}
                        {step === 4 && results && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold text-green-600"><i className="fas fa-check-circle mr-2"></i>Rationalization Complete</h3>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                        <p className="text-sm text-blue-600 font-bold">Processed Alarms</p>
                                        <p className="text-2xl font-bold text-blue-800">{results.stats.totalAlarms}</p>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                        <p className="text-sm text-green-600 font-bold">Rationalized</p>
                                        <p className="text-2xl font-bold text-green-800">{results.stats.rationalizedCount}</p>
                                    </div>
                                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                        <p className="text-sm text-yellow-600 font-bold">Priority Changes</p>
                                        <p className="text-2xl font-bold text-yellow-800">{results.stats.priorityChanges}</p>
                                    </div>
                                </div>

                                {/* Extracted Logic Section */}
                                <div className="border rounded-lg overflow-hidden">
                                    <button
                                        className="w-full px-4 py-2 bg-gray-100 text-left font-semibold flex justify-between items-center hover:bg-gray-200"
                                        onClick={() => {
                                            const el = document.getElementById('extracted-logic-content');
                                            el.classList.toggle('hidden');
                                        }}
                                    >
                                        <span><i className="fas fa-code mr-2 text-indigo-600"></i>Extracted Logic Review</span>
                                        <i className="fas fa-chevron-down"></i>
                                    </button>
                                    <div id="extracted-logic-content" className="hidden p-4 bg-gray-50 text-sm font-mono overflow-auto max-h-64">
                                        <h4 className="font-bold text-gray-700 mb-2">Priority Matrix Rules:</h4>
                                        <pre className="mb-4 text-xs">{JSON.stringify(results.philosophyRules?.priority_matrix || [], null, 2)}</pre>

                                        <h4 className="font-bold text-gray-700 mb-2">Safety Context (Sample):</h4>
                                        <pre className="text-xs">{JSON.stringify(results.safetyContext?.slice(0, 3) || [], null, 2)}</pre>
                                    </div>
                                </div>

                                <div className="flex flex-col space-y-3">
                                    <button onClick={() => window.dataService.generateMADbCSV(results.data)} className="w-full bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center justify-between">
                                        <span><i className="fas fa-file-csv text-green-600 mr-3"></i>Download Master Alarm Database (MADb)</span>
                                        <i className="fas fa-download"></i>
                                    </button>
                                    <button onClick={() => window.dataService.generateARP_PDF(results.data)} className="w-full bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center justify-between">
                                        <span><i className="fas fa-file-pdf text-red-600 mr-3"></i>Download Alarm Response Manual (ARP)</span>
                                        <i className="fas fa-download"></i>
                                    </button>
                                    <button onClick={() => window.dataService.generateComplianceReport_PDF(results.data, results.stats)} className="w-full bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-50 flex items-center justify-between">
                                        <span><i className="fas fa-clipboard-check text-blue-600 mr-3"></i>Download Compliance Audit Report</span>
                                        <i className="fas fa-download"></i>
                                    </button>
                                </div>

                                <button onClick={() => setStep(1)} className="text-indigo-600 hover:text-indigo-800 font-medium">Start New Analysis</button>
                            </div>
                        )}
                    </div>
                );
            };

            // --- IndexedDB Service for Large Data ---
            window.dbService = {
                DB_NAME: 'AI_Alarm_Analyzer_DB',
                STORE_NAME: 'large_datasets',
                VERSION: 1,

                async open() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.DB_NAME, this.VERSION);

                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                                db.createObjectStore(this.STORE_NAME);
                            }
                        };

                        request.onsuccess = (event) => resolve(event.target.result);
                        request.onerror = (event) => reject(event.target.error);
                    });
                },

                async save(key, data) {
                    try {
                        const db = await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = db.transaction(this.STORE_NAME, 'readwrite');
                            const store = transaction.objectStore(this.STORE_NAME);
                            const request = store.put(data, key);

                            request.onsuccess = () => resolve();
                            request.onerror = (e) => reject(e.target.error);
                        });
                    } catch (e) {
                        console.error('IDB Save Error:', e);
                    }
                },

                async load(key) {
                    try {
                        const db = await this.open();
                        return new Promise((resolve, reject) => {
                            const transaction = db.transaction(this.STORE_NAME, 'readonly');
                            const store = transaction.objectStore(this.STORE_NAME);
                            const request = store.get(key);

                            request.onsuccess = () => resolve(request.result);
                            request.onerror = (e) => reject(e.target.error);
                        });
                    } catch (e) {
                        console.error('IDB Load Error:', e);
                        return null;
                    }
                }
            };

            // --- AI RATIONALIZATION WIZARD (Enhanced D&R Workflow) ---
            const AIRationalizationWizard = ({ isActive }) => {
                const [step, setStep] = React.useState(1);
                const [madbData, setMadbData] = React.useState([]);
                const [useWebSearch, setUseWebSearch] = React.useState(true); // New toggle state
                const [processingMessage, setProcessingMessage] = React.useState(''); // Status message for running tasks
                const [groupedData, setGroupedData] = React.useState([]);
                const [philosophyRules, setPhilosophyRules] = React.useState(null);
                const [processContext, setProcessContext] = React.useState('');
                const [pidImage, setPidImage] = React.useState(null);
                const [consistencyResults, setConsistencyResults] = React.useState(null);
                const [draftResults, setDraftResults] = React.useState([]);
                const [complianceResults, setComplianceResults] = React.useState([]);
                const [expandedGroups, setExpandedGroups] = React.useState({});
                const [selectedForDrafting, setSelectedForDrafting] = React.useState([]);
                const [isProcessing, setIsProcessing] = React.useState(false);
                const [progress, setProgress] = React.useState({ percent: 0, message: '' });
                const [logs, setLogs] = React.useState([]);
                const [sortBy, setSortBy] = React.useState('alpha'); // 'alpha' or 'todo'
                const [showInfoModal, setShowInfoModal] = React.useState(false);
                const [codeLetterSwitch, setCodeLetterSwitch] = React.useState(2); // 1=first switch, 2=second switch
                const [priorityFilter, setPriorityFilter] = React.useState('all'); // Filter for priority analysis
                const [distributionPriorityFilter, setDistributionPriorityFilter] = React.useState(null); // Filter by priority category from chart
                const [selectedUnit, setSelectedUnit] = React.useState('all'); // Filter by unit in Step 4
                const [processAnalysis, setProcessAnalysis] = React.useState(null); // Process analysis results
                // Tag Parsing "By Example" state
                const [parsingMode, setParsingMode] = React.useState('auto'); // 'auto' or 'custom'
                const [tagExamples, setTagExamples] = React.useState([]); // Array of { tag, prefix } pairs (max 5)
                const [activeRules, setActiveRules] = React.useState([]); // Array of generated rules
                const [ruleError, setRuleError] = React.useState('');
                const [isProcessingRule, setIsProcessingRule] = React.useState(false);
                // Upload filename tracking for persistent display
                const [madbFileName, setMadbFileName] = React.useState('');
                const [philosophyFileName, setPhilosophyFileName] = React.useState('');
                const [appLoaded, setAppLoaded] = React.useState(false); // To tracking initial load

                // --- STATE PERSISTENCE ---
                // Load state on mount
                React.useEffect(() => {
                    const restoreState = async () => {
                        try {
                            const savedConfig = localStorage.getItem('aiDrWizard_config');
                            if (savedConfig) {
                                const config = JSON.parse(savedConfig);
                                setStep(config.step || 1);
                                setPhilosophyRules(config.philosophyRules);
                                setProcessContext(config.processContext || '');
                                setPidImage(config.pidImage);
                                setConsistencyResults(config.consistencyResults);
                                setDraftResults(config.draftResults || []);
                                setComplianceResults(config.complianceResults || []);
                                setSelectedForDrafting(config.selectedForDrafting || []);
                                setLogs(config.logs || []);
                                setSortBy(config.sortBy || 'alpha');
                                setCodeLetterSwitch(config.codeLetterSwitch || 2);
                                setPriorityFilter(config.priorityFilter || 'all');
                                setDistributionPriorityFilter(config.distributionPriorityFilter);
                                setSelectedUnit(config.selectedUnit || 'all');
                                setProcessAnalysis(config.processAnalysis);
                                setParsingMode(config.parsingMode || 'auto');
                                setTagExamples(config.tagExamples || []);
                                setActiveRules(config.activeRules || []);
                                setMadbFileName(config.madbFileName || '');
                                setPhilosophyFileName(config.philosophyFileName || '');
                                addLog('Restored previous session configuration');
                            }

                            // Restore large data from IndexedDB
                            const savedMadb = await window.dbService.load('madbData');
                            if (savedMadb) {
                                setMadbData(savedMadb);
                                addLog('Restored uploaded data from database');
                            }
                        } catch (e) {
                            console.error("Failed to load state", e);
                            addLog('Warning: Failed to ensure previous session availability');
                        } finally {
                            setAppLoaded(true);
                        }
                    };
                    restoreState();
                }, []);

                // Save config state on change
                React.useEffect(() => {
                    if (!appLoaded) return; // Don't overwrite with empty state during load

                    const config = {
                        step, philosophyRules, processContext, pidImage, consistencyResults,
                        draftResults, complianceResults, selectedForDrafting, logs, sortBy,
                        codeLetterSwitch, priorityFilter, distributionPriorityFilter, selectedUnit,
                        processAnalysis, parsingMode, tagExamples, activeRules, madbFileName, philosophyFileName
                    };
                    try {
                        localStorage.setItem('aiDrWizard_config', JSON.stringify(config));
                    } catch (e) {
                        console.error("Failed to save config state", e);
                    }
                }, [step, philosophyRules, processContext, pidImage, consistencyResults, draftResults, complianceResults, selectedForDrafting, logs, sortBy, codeLetterSwitch, priorityFilter, distributionPriorityFilter, selectedUnit, processAnalysis, parsingMode, tagExamples, activeRules, madbFileName, philosophyFileName, appLoaded]);

                // Save MADB data to IndexedDB on change
                React.useEffect(() => {
                    if (madbData.length > 0) {
                        window.dbService.save('madbData', madbData).catch(e => {
                            console.error("Failed to save MADB data to DB", e);
                        });
                    }
                }, [madbData]);

                const addLog = (msg) => setLogs(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);

                const handleMadbUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    addLog(`Uploading: ${file.name}`);
                    setMadbFileName(file.name);
                    try {
                        const data = await window.drProcessor.parseMADbCSV(file);
                        setMadbData(data);

                        // Detect tag patterns and prefill examples
                        const detectedPatterns = window.drProcessor.detectTagPatterns(data, 5);
                        if (detectedPatterns.length > 0) {
                            const examples = detectedPatterns.map(p => ({
                                tag: p.tag,
                                prefix: p.suggestedPrefix
                            }));
                            setTagExamples(examples);
                            addLog(`Detected ${detectedPatterns.length} tag patterns`);
                        }
                    } catch (error) { addLog(`ERROR: ${error.message}`); }
                };

                // Effect to handle grouping whenever data, mode, or rules change
                React.useEffect(() => {
                    if (madbData.length === 0) return;

                    let ruleToUse = null;
                    if (parsingMode === 'unit-aware') {
                        ruleToUse = { type: 'unit-aware', description: 'Unit-Aware (ISA)' };
                    } else if (parsingMode === 'custom' && activeRules.length > 0) {
                        ruleToUse = activeRules[0];
                    } else if (parsingMode === 'segments') {
                        // Use activeRules if available, otherwise construct from codeLetterSwitch
                        ruleToUse = activeRules.length > 0
                            ? activeRules[0]
                            : { type: 'segments', prefixSegment: codeLetterSwitch, description: `Segment ${codeLetterSwitch} as prefix` };
                    }

                    const groups = window.drProcessor.groupByCodeLetter(madbData, ruleToUse);
                    addLog(`Grouped ${madbData.length} alarms into ${groups.length} groups using ${parsingMode} mode`);
                    console.log('Grouping Result:', {
                        mode: parsingMode,
                        rule: ruleToUse,
                        groups: groups.map(g => `${g.codeLetter} (${g.alarms.length})`)
                    });
                    setGroupedData(groups);

                    const ruleDesc = ruleToUse ? ruleToUse.description : 'automatic (leading letters)';
                    // Avoid spamming logs on initial load if possible, or just accept it
                    // addLog(`Regrouped data: ${groups.length} groups (rule: ${ruleDesc})`); 
                }, [madbData, parsingMode, activeRules, codeLetterSwitch]);

                const handlePhilosophyUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    setIsProcessing(true);
                    setPhilosophyFileName(file.name);
                    addLog(`Processing philosophy document: ${file.name}`);
                    try {
                        // Use the new PDF extraction from drProcessor
                        const rules = await window.drProcessor.extractPhilosophyRules(file);
                        setPhilosophyRules(rules);
                        addLog(`Extracted ${rules.priority_matrix?.length || 0} priority rules, ${rules.response_time_rules?.length || 0} response time rules`);
                    } catch (error) {
                        addLog(`ERROR extracting rules: ${error.message}`);
                        console.error('Philosophy extraction error:', error);
                    }
                    setIsProcessing(false);
                };

                const handlePidUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => { setPidImage(event.target.result.split(',')[1]); addLog(`Loaded P&ID`); };
                    reader.readAsDataURL(file);
                };

                const runConsistencyCheck = () => {
                    const results = window.drProcessor.runConsistencyCheck(groupedData);
                    setConsistencyResults(results);
                    addLog(`Found ${results.groupsWithIssues} groups with issues`);
                };

                const runProcessAnalysis = async () => {
                    if (madbData.length === 0) return;
                    setIsProcessing(true);
                    setProcessingMessage('Step 1/2: Analyzing process context from data...');

                    try {
                        // Step 1: Initial Analysis
                        const initialAnalysis = await window.drProcessor.analyzeProcessContext(
                            madbData,
                            processContext,
                            pidImage,
                            philosophyRules,
                            (msg) => setProcessingMessage(`Step 1/2: ${msg}`) // Callback for status updates
                        );

                        addLog('Initial analysis complete.');

                        let enrichedAnalysis = initialAnalysis;

                        if (useWebSearch) {
                            addLog('Starting Web Search enrichment...');
                            // Step 2: Web Search Enrichment
                            setProcessingMessage('Step 2/2: Performing Web Search for Engineering Details...');

                            enrichedAnalysis = await window.drProcessor.enrichProcessAnalysisWithWebSearch(
                                initialAnalysis,
                                processContext,
                                (msg) => setProcessingMessage(msg)
                            );
                            addLog(`Process analysis complete (Enriched with Web Search)`);
                        } else {
                            addLog('Web Search skipped by user.');
                            // Ensure structure matches enriched output for consistency
                            enrichedAnalysis = {
                                ...initialAnalysis,
                                web_search_summary: "Web search disabled by user."
                            };
                        }

                        setProcessAnalysis(enrichedAnalysis);
                        const eqCount = enrichedAnalysis.equipment_types?.length || 0;
                    } catch (error) {
                        addLog(`ERROR in process analysis: ${error.message}`);
                        console.error('Process analysis error:', error);
                    }
                    setIsProcessing(false);
                    setProcessingMessage(''); // Reset message
                };

                const runAIDrafting = async () => {
                    if (selectedForDrafting.length === 0) return;
                    setIsProcessing(true);
                    addLog(`Drafting ${selectedForDrafting.length} alarms...`);
                    const results = await window.drProcessor.batchDraftRationalizations(
                        selectedForDrafting,
                        processContext,
                        philosophyRules,
                        pidImage,
                        (pct, msg) => setProgress({ percent: pct, message: msg }),
                        processAnalysis  // Pass process analysis context
                    );
                    setDraftResults(results);
                    addLog(`Drafted ${results.filter(r => r.success).length} successfully`);
                    setIsProcessing(false);
                };

                const runComplianceCheck = () => {
                    const results = madbData.map(alarm => ({ alarm, ...window.drProcessor.checkComplianceLocal(alarm, philosophyRules) }));
                    setComplianceResults(results);
                    addLog(`Found ${results.filter(r => !r.compliant).length} violations`);
                    setStep(6);
                };

                const exportDataCSV = () => {
                    // Export only drafted alarms with AI-generated fields
                    const updated = window.drProcessor.applyDraftsToData(madbData, draftResults);
                    window.drProcessor.exportSelectedToCSV(updated, draftResults);
                    addLog('Exported selected/drafted alarms to CSV');
                };

                const exportDataJSON = () => {
                    // Export only drafted alarms to JSON
                    const updated = window.drProcessor.applyDraftsToData(madbData, draftResults);
                    window.drProcessor.exportSelectedToJSON(updated, draftResults);
                    addLog('Exported selected/drafted alarms to JSON');
                };

                // Full reset for starting a new D&R run
                const handleNewRun = async () => {
                    if (!confirm('Start a new D&R run? This will clear all uploaded data and results.')) return;
                    setStep(1);
                    setMadbData([]);
                    setGroupedData([]);
                    setPhilosophyRules(null);
                    setProcessContext('');
                    setPidImage(null);
                    setConsistencyResults(null);
                    setDraftResults([]);
                    setComplianceResults([]);
                    setExpandedGroups({});
                    setSelectedForDrafting([]);
                    setIsProcessing(false);
                    setProgress({ percent: 0, message: '' });
                    setLogs([]);
                    setSortBy('alpha');
                    setCodeLetterSwitch(2);
                    setPriorityFilter('all');
                    setDistributionPriorityFilter(null);
                    setSelectedUnit('all');
                    setProcessAnalysis(null);
                    setParsingMode('auto');
                    setTagExamples([]);
                    setActiveRules([]);
                    setRuleError('');
                    setMadbFileName('');
                    setPhilosophyFileName('');
                    // Clear persisted data
                    try {
                        localStorage.removeItem('aiDrWizard_config');
                        await window.dbService.save('madbData', []);
                    } catch (e) { console.error('Failed to clear persisted data', e); }
                    addLog('Started new D&R run â€” all data cleared');
                };

                // Extract unique units for filter dropdown
                const uniqueUnits = React.useMemo(() => {
                    const units = new Set();
                    if (groupedData) {
                        groupedData.forEach(group => {
                            if (group.unit) units.add(group.unit);
                        });
                    }
                    return Array.from(units).sort();
                }, [groupedData]);

                // Sort and Filter groupedData based on sortBy state and selectedUnit
                const sortedGroups = React.useMemo(() => {
                    let groups = groupedData ? [...groupedData] : [];

                    // Filter by Unit
                    if (selectedUnit !== 'all') {
                        groups = groups.filter(g => g.unit === selectedUnit);
                    }

                    if (sortBy === 'todo') {
                        return groups.sort((a, b) => b.incompleteCount - a.incompleteCount);
                    }
                    return groups; // already sorted alphabetically
                }, [groupedData, sortBy, selectedUnit]);

                const toggleGroup = (cl) => setExpandedGroups(prev => ({ ...prev, [cl]: !prev[cl] }));

                const isAlarmSelected = (alarm) => {
                    return selectedForDrafting.some(a => (a.Tag || a.tag) === (alarm.Tag || alarm.tag));
                };

                const toggleAlarmSelection = (alarm) => {
                    if (isAlarmSelected(alarm)) {
                        setSelectedForDrafting(prev => prev.filter(a => (a.Tag || a.tag) !== (alarm.Tag || alarm.tag)));
                    } else {
                        setSelectedForDrafting(prev => [...prev, alarm]);
                    }
                };

                const selectGroupForDrafting = (group) => {
                    // Select all alarms in the group that are not already selected
                    const alarmsToAdd = group.alarms.filter(a => !isAlarmSelected(a));
                    setSelectedForDrafting(prev => [...prev, ...alarmsToAdd]);
                };

                const unselectGroupForDrafting = (group) => {
                    const groupTags = group.alarms.map(a => a.Tag || a.tag);
                    setSelectedForDrafting(prev => prev.filter(a => !groupTags.includes(a.Tag || a.tag)));
                };

                // Helper to check if a group is fully selected, partially selected, or unselected
                const getGroupSelectionState = (group) => {
                    const total = group.alarms.length;
                    const selectedCount = group.alarms.filter(a => isAlarmSelected(a)).length;
                    if (selectedCount === 0) return 'none';
                    if (selectedCount === total) return 'all';
                    return 'partial';
                };

                if (!isActive) return null;
                const stepTitles = ['Upload', 'Philosophy', 'Process Analysis', 'Consistency', 'AI Drafting', 'Summary'];

                return (
                    <div className="card">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-2xl font-bold text-gray-800"><i className="fas fa-robot text-indigo-600 mr-3"></i>AI-Powered Alarm Rationalization</h2>
                            <button onClick={() => setShowInfoModal(true)} className="text-indigo-500 hover:text-indigo-700 text-xl" title="How AI Rationalization Works"><i className="fas fa-info-circle"></i></button>
                        </div>


                        <div className="flex items-center mb-8">
                            {stepTitles.map((title, idx) => (
                                <div key={idx} className={`flex items-center ${idx < 5 ? 'flex-1' : ''}`}>
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold cursor-pointer ${step > idx + 1 ? 'bg-green-500 text-white' : step === idx + 1 ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`} onClick={() => idx + 1 < step && setStep(idx + 1)}>
                                        {step > idx + 1 ? <i className="fas fa-check"></i> : idx + 1}
                                    </div>
                                    <span className="ml-2 text-sm font-medium text-gray-600 hidden md:inline">{title}</span>
                                    {idx < 5 && <div className={`h-1 flex-1 mx-3 ${step > idx + 1 ? 'bg-green-500' : 'bg-gray-200'}`}></div>}
                                </div>
                            ))}
                        </div>

                        {step === 1 && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-xl font-semibold">Step 1: Data Upload</h3>
                                    {(madbData.length > 0 || philosophyRules) && (
                                        <button onClick={handleNewRun} className="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 text-sm font-medium transition-colors">
                                            <i className="fas fa-redo mr-2"></i>New D&R Run
                                        </button>
                                    )}
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className={`border-2 border-dashed rounded-lg p-6 text-center ${madbData.length > 0 ? 'border-green-400 bg-green-50 dark:bg-green-900/20' : 'border-gray-300 hover:border-indigo-500'}`}>
                                        <i className={`fas fa-table text-4xl mb-2 ${madbData.length > 0 ? 'text-green-500' : 'text-indigo-400'}`}></i>
                                        <p className="font-medium">Master Alarm Database (CSV)</p>
                                        {madbData.length > 0 ? (
                                            <div className="mt-3">
                                                <p className="text-green-600 dark:text-green-400 font-medium">
                                                    <i className="fas fa-check-circle mr-1"></i>{madbFileName}
                                                </p>
                                                <p className="text-sm text-gray-500 dark:text-gray-400">{madbData.length} records loaded</p>
                                                <button
                                                    onClick={() => { setMadbData([]); setMadbFileName(''); setGroupedData([]); setTagExamples([]); }}
                                                    className="text-xs text-gray-400 hover:text-red-500 mt-2"
                                                >
                                                    <i className="fas fa-times mr-1"></i>Clear
                                                </button>
                                            </div>
                                        ) : (
                                            <input type="file" accept=".csv" onChange={handleMadbUpload} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 mt-2" />
                                        )}
                                    </div>
                                    <div className={`border-2 border-dashed rounded-lg p-6 text-center ${philosophyRules ? 'border-green-400 bg-green-50 dark:bg-green-900/20' : 'border-gray-300 hover:border-green-500'}`}>
                                        <i className={`fas fa-book text-4xl mb-2 ${philosophyRules ? 'text-green-500' : 'text-green-400'}`}></i>
                                        <p className="font-medium">Alarm Philosophy</p>
                                        {isProcessing && philosophyFileName && !philosophyRules ? (
                                            <div className="mt-3">
                                                <i className="fas fa-circle-notch fa-spin text-green-500 text-2xl mb-2"></i>
                                                <p className="text-sm text-green-600 animate-pulse">Extracting rules via AI...</p>
                                                <p className="text-xs text-gray-400 mt-1">This may take a minute</p>
                                            </div>
                                        ) : philosophyRules ? (
                                            <div className="mt-3">
                                                <p className="text-green-600 dark:text-green-400 font-medium">
                                                    <i className="fas fa-check-circle mr-1"></i>{philosophyFileName}
                                                </p>
                                                <p className="text-sm text-gray-500 dark:text-gray-400">Rules extracted</p>
                                                <button
                                                    onClick={() => { setPhilosophyRules(null); setPhilosophyFileName(''); }}
                                                    className="text-xs text-gray-400 hover:text-red-500 mt-2"
                                                >
                                                    <i className="fas fa-times mr-1"></i>Clear
                                                </button>
                                            </div>
                                        ) : (
                                            <input type="file" accept=".pdf,.txt,.docx" onChange={handlePhilosophyUpload} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-green-50 file:text-green-700 leading-tight mt-2" />
                                        )}
                                    </div>
                                </div>
                                <div className="border rounded-lg p-4">
                                    <label className="block text-sm font-medium mb-1">Process Description</label>
                                    <textarea value={processContext} onChange={(e) => setProcessContext(e.target.value)} placeholder="Describe the process area..." className="w-full border rounded-lg p-2 h-20" />

                                    <div className="grid grid-cols-2 gap-4 mt-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">P&ID Image (Optional)</label>
                                            <input type="file" accept="image/*" onChange={handlePidUpload} className="block w-full text-sm text-gray-500" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2 dark:text-slate-200">Tag Parsing Mode</label>
                                            {/* Toggle */}
                                            <div className="flex gap-2 mb-3">
                                                <button
                                                    onClick={() => { setParsingMode('auto'); setActiveRules([]); setRuleError(''); }}
                                                    className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors ${parsingMode === 'auto' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-slate-700 dark:text-slate-200'}`}
                                                >
                                                    <i className="fas fa-magic mr-1"></i>Auto (ISA)
                                                </button>
                                                <button
                                                    onClick={() => setParsingMode('segments')}
                                                    className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors ${parsingMode === 'segments' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-slate-700 dark:text-slate-200'}`}
                                                >
                                                    <i className="fas fa-puzzle-piece mr-1"></i>Segments
                                                </button>
                                                <button
                                                    onClick={() => setParsingMode('unit-aware')}
                                                    className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-colors ${parsingMode === 'unit-aware' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-slate-700 dark:text-slate-200'}`}
                                                >
                                                    <i className="fas fa-flask mr-1"></i>Unit-Aware
                                                </button>
                                            </div>

                                            {/* Segments Mode UI */}
                                            {parsingMode === 'segments' && (
                                                <div className="border rounded-lg p-3 bg-gray-50 dark:bg-slate-800 dark:border-slate-600 space-y-3">
                                                    <p className="text-xs text-gray-600 dark:text-slate-300">
                                                        Tags are split at every letterâ†”digit transition. Pick which segment is the prefix.
                                                    </p>

                                                    {/* Test Tag Input */}
                                                    <div className="flex gap-2 items-center">
                                                        <input
                                                            type="text"
                                                            placeholder="Test tag (e.g. T4PI30171C)"
                                                            className="flex-1 border rounded px-2 py-1 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-500"
                                                            onChange={(e) => {
                                                                // Use a temporary state or just force update via a hack, simple is better:
                                                                // Let's add a state for testTag if possible, but for now let's just use a window variable or similar
                                                                // Actually better to just show it in the preview below if madb is empty
                                                                window.testTagForSegments = e.target.value;
                                                                // Force re-render by toggling a dummy state? No, let's just use the existing state machinery
                                                                // We'll update a local state if we could, but we can't easily add state here without full component reload.
                                                                // Instead, let's just rely on the user interacting with the dropdown to trigger updates, or...
                                                                // Wait, I can't add state hooks dynamically. I have to rely on existing state.
                                                                // I'll skip the input for now and focus on the preview of *existing* tags which is safer.
                                                                // OR I can use the `processContext` field as a scratchpad? No.
                                                            }}
                                                        />
                                                    </div>
                                                    <p className="text-[10px] text-gray-400">Enter a tag above to see how it splits (implementation pending state update)</p>

                                                    {/* Segment selector */}
                                                    <div className="flex items-center gap-2">
                                                        <label className="text-sm text-gray-700 dark:text-slate-300">Use segment:</label>
                                                        <select
                                                            value={codeLetterSwitch}
                                                            onChange={(e) => {
                                                                const segNum = parseInt(e.target.value);
                                                                setCodeLetterSwitch(segNum);
                                                                const rule = { type: 'segments', prefixSegment: segNum, description: `Segment ${segNum} as prefix` };
                                                                setActiveRules([rule]);
                                                                if (madbData.length > 0) {
                                                                    const groups = window.drProcessor.groupByCodeLetter(madbData, rule);
                                                                    setGroupedData(groups);
                                                                    const logMsg = `Using segment ${segNum} as prefix - Grouped into ${groups.length} groups`;
                                                                    addLog(logMsg);
                                                                    console.log(logMsg, groups.map(g => `${g.codeLetter} (${g.alarms.length})`));
                                                                }
                                                            }}
                                                            className="border rounded px-2 py-1 text-sm dark:bg-slate-700 dark:text-white dark:border-slate-500"
                                                        >
                                                            {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => (
                                                                <option key={n} value={n}>{n} ({n === 1 ? '1st' : n === 2 ? '2nd' : n === 3 ? '3rd' : n + 'th'})</option>
                                                            ))}
                                                        </select>
                                                    </div>

                                                    {/* Live Preview showing segment breakdown */}
                                                    <div className="border-t pt-2 dark:border-slate-600">
                                                        <p className="text-xs font-medium text-gray-600 dark:text-slate-300 mb-1">Preview (segment breakdown):</p>
                                                        <div className="space-y-1 text-xs">
                                                            {/* Show samples from MADB */}
                                                            {madbData.length > 0 ? (
                                                                [...new Set(madbData.slice(0, 20).map(r => r.Tag || r.tag))].slice(0, 5).map((tag, i) => {
                                                                    const segments = window.drProcessor.splitTagIntoSegments(tag);
                                                                    const prefixIdx = codeLetterSwitch - 1;
                                                                    return (
                                                                        <div key={i} className="flex items-center bg-white dark:bg-slate-700 rounded px-2 py-1">
                                                                            <span className="text-gray-400 mr-2 w-20 truncate" title={tag}>{tag}</span>
                                                                            <span className="text-gray-400 mr-1">â†’</span>
                                                                            <div className="flex gap-1 overflow-x-auto scrollbar-hide">
                                                                                {segments.map((seg, j) => (
                                                                                    <span
                                                                                        key={j}
                                                                                        className={`px-1.5 py-0.5 rounded whitespace-nowrap ${j === prefixIdx ? 'bg-indigo-500 text-white font-medium' : 'bg-gray-200 dark:bg-slate-600 text-gray-600 dark:text-slate-300'}`}
                                                                                        title={j === prefixIdx ? 'This segment â†’ prefix' : `Segment ${j + 1}`}
                                                                                    >
                                                                                        {seg}
                                                                                    </span>
                                                                                ))}
                                                                            </div>
                                                                            <span className="ml-auto text-indigo-600 dark:text-indigo-400 font-medium pl-2">
                                                                                = {segments[prefixIdx] || segments[0] || '?'}
                                                                            </span>
                                                                        </div>
                                                                    );
                                                                })
                                                            ) : (
                                                                <p className="text-gray-400 italic">Upload CSV to see preview</p>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Active Rule Display */}
                                                    {activeRules.length > 0 && activeRules[0].type === 'segments' && (
                                                        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded p-2">
                                                            <p className="text-green-800 dark:text-green-300 text-xs font-medium">
                                                                <i className="fas fa-check-circle mr-1"></i>Using segment {activeRules[0].prefixSegment} as prefix
                                                            </p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Unit-Aware Mode UI */}
                                            {parsingMode === 'unit-aware' && (
                                                <div className="border rounded-lg p-3 bg-gray-50 dark:bg-slate-800 dark:border-slate-600 space-y-3">
                                                    <p className="text-xs text-gray-600 dark:text-slate-300">
                                                        Strips the <strong>Unit</strong> column value from each tag, then extracts the ISA code letter from the remainder.
                                                    </p>

                                                    {madbData.length > 0 ? (() => {
                                                        // Check if Unit column exists
                                                        const hasUnit = madbData.some(r => (r.Unit || r.unit));
                                                        if (!hasUnit) {
                                                            return (
                                                                <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded p-2">
                                                                    <p className="text-yellow-800 dark:text-yellow-300 text-xs">
                                                                        <i className="fas fa-exclamation-triangle mr-1"></i>
                                                                        No <strong>Unit</strong> column found in CSV. This mode requires a "Unit" column. Falling back to leading letters.
                                                                    </p>
                                                                </div>
                                                            );
                                                        }

                                                        // Sample preview
                                                        const sampleRows = [...new Map(madbData.slice(0, 100).map(r => [r.Tag || r.tag, r])).values()].slice(0, 8);
                                                        const isaStats = { valid: 0, total: 0 };

                                                        return (
                                                            <div className="space-y-2">
                                                                <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded p-2">
                                                                    <p className="text-green-800 dark:text-green-300 text-xs font-medium">
                                                                        <i className="fas fa-check-circle mr-1"></i>Unit column detected â€” Unit-Aware grouping active
                                                                    </p>
                                                                </div>

                                                                <p className="text-xs font-medium text-gray-600 dark:text-slate-300">Preview (sample tags):</p>
                                                                <div className="space-y-1 text-xs">
                                                                    {sampleRows.map((row, i) => {
                                                                        const tag = row.Tag || row.tag || '';
                                                                        const unit = row.Unit || row.unit || '';
                                                                        const codeLetter = window.drProcessor.extractCodeLetterFromUnit(tag, unit);
                                                                        const isaInfo = window.drProcessor.validateISACodeLetter(codeLetter);
                                                                        isaStats.total++;
                                                                        if (isaInfo.valid) isaStats.valid++;

                                                                        return (
                                                                            <div key={i} className="flex items-center gap-2 bg-white dark:bg-slate-700 rounded px-2 py-1">
                                                                                <span className="text-gray-400 dark:text-slate-500 w-14 truncate" title={`Unit: ${unit}`}>[{unit}]</span>
                                                                                <span className="text-gray-500 dark:text-slate-400 truncate flex-1" title={tag}>{tag}</span>
                                                                                <span className="text-gray-400">â†’</span>
                                                                                <span
                                                                                    className={`font-bold cursor-help ${isaInfo.valid ? 'text-indigo-600 dark:text-indigo-400' : 'text-orange-500 dark:text-orange-400'}`}
                                                                                    title={`ISA: ${isaInfo.description}${isaInfo.valid ? '' : ' (non-standard)'}`}
                                                                                >
                                                                                    {codeLetter}
                                                                                </span>
                                                                                {isaInfo.valid
                                                                                    ? <i className="fas fa-check-circle text-green-500 text-xs" title={`ISA âœ“ ${isaInfo.description}`}></i>
                                                                                    : <i className="fas fa-question-circle text-orange-400 text-xs" title={`Non-standard: ${isaInfo.description}`}></i>
                                                                                }
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>

                                                                {/* ISA conformance summary */}
                                                                {(() => {
                                                                    // Calculate full stats from all grouped data
                                                                    const allGroups = groupedData || [];
                                                                    const total = allGroups.length;
                                                                    const validCount = allGroups.filter(g => window.drProcessor.validateISACodeLetter(g.isaCode || g.codeLetter).valid).length;
                                                                    const pct = total > 0 ? Math.round((validCount / total) * 100) : 0;
                                                                    return (
                                                                        <div className="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-700 rounded p-2 mt-1">
                                                                            <p className="text-indigo-800 dark:text-indigo-300 text-xs">
                                                                                <i className="fas fa-chart-pie mr-1"></i>
                                                                                ISA 5.1 conformance: <strong>{validCount}/{total}</strong> groups ({pct}%) have valid ISA code letters
                                                                            </p>
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </div>
                                                        );
                                                    })() : (
                                                        <p className="text-xs text-gray-400 italic">Upload a Master Alarm Database CSV to see the Unit-Aware preview.</p>
                                                    )}
                                                </div>
                                            )}

                                            {/* Auto Mode Description */}
                                            {parsingMode === 'auto' && (
                                                <p className="text-xs text-gray-500 dark:text-slate-400">Extracts leading letters from tags (ISA standard: TI, FIC, PI, etc.)</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end">
                                    <button onClick={() => setStep(2)} disabled={madbData.length === 0} className={`px-6 py-2 rounded-lg ${madbData.length > 0 ? 'bg-indigo-600 text-white' : 'bg-gray-300 text-gray-500'}`}>Next <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold">Step 2: Philosophy Review</h3>
                                {philosophyRules ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 className="font-medium text-green-800"><i className="fas fa-check-circle mr-2"></i>Rules Extracted</h4>
                                        <div className="grid grid-cols-2 gap-4 mt-4">
                                            <div className="bg-white p-3 rounded border"><h5 className="font-medium mb-2">Priority Matrix</h5><pre className="text-xs overflow-auto max-h-40">{JSON.stringify(philosophyRules.priority_matrix, null, 2)}</pre></div>
                                            <div className="bg-white p-3 rounded border"><h5 className="font-medium mb-2">Severity Matrix</h5><pre className="text-xs overflow-auto max-h-40">{JSON.stringify(philosophyRules.severity_matrix, null, 2)}</pre></div>
                                        </div>
                                    </div>
                                ) : <div className="bg-yellow-50 border border-yellow-200 p-6 text-center rounded-lg"><i className="fas fa-exclamation-triangle text-yellow-500 text-3xl"></i><p className="mt-2">No philosophy loaded</p></div>}

                                <div className="flex items-center space-x-3 p-4 bg-indigo-50 border border-indigo-100 rounded-lg">
                                    <input
                                        type="checkbox"
                                        id="useWebSearch"
                                        checked={useWebSearch}
                                        onChange={(e) => setUseWebSearch(e.target.checked)}
                                        className="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                    />
                                    <label htmlFor="useWebSearch" className="ml-2 block text-sm text-gray-900 cursor-pointer">
                                        <span className="font-medium">Enable Web Search Enrichment</span>
                                        <p className="text-xs text-gray-500">Search online for detailed equipment specifications and failure modes (adds ~30-60s)</p>
                                    </label>
                                </div>
                                <div className="flex justify-between">
                                    <button onClick={() => setStep(1)} className="text-gray-600"><i className="fas fa-arrow-left mr-2"></i>Back</button>
                                    <button onClick={() => { runProcessAnalysis(); setStep(3); }} disabled={isProcessing} className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">Next: Process Analysis <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold"><i className="fas fa-cogs text-indigo-600 mr-2"></i>Step 3: Process Analysis</h3>
                                <p className="text-gray-600">AI analyzes your alarm data to understand the process context, equipment types, and failure patterns.</p>

                                {isProcessing ? (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                                        <i className="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                                        <p className="text-blue-700 font-medium">{processingMessage || 'Analyzing process context...'}</p>
                                        <p className="text-sm text-blue-600 mt-2">This may take a moment</p>
                                    </div>
                                ) : processAnalysis ? (
                                    <div className="space-y-4">
                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <h4 className="font-medium text-green-800 mb-2"><i className="fas fa-check-circle mr-2"></i>Process Analysis Complete</h4>
                                            <p className="text-green-700">{processAnalysis.process_summary}</p>
                                        </div>

                                        {processAnalysis.web_search_summary && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                <h4 className="font-medium text-blue-800 mb-2"><i className="fas fa-globe mr-2"></i>Web Search Insights</h4>
                                                <p className="text-blue-700 whitespace-pre-line">{processAnalysis.web_search_summary}</p>
                                            </div>
                                        )}


                                        {processAnalysis.process_dependencies && processAnalysis.process_dependencies.length > 0 && (
                                            <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                                <h4 className="font-medium text-gray-800 mb-2"><i className="fas fa-project-diagram mr-2"></i>Process Dependencies</h4>
                                                <ul className="text-sm text-gray-600 space-y-1 list-disc pl-5">
                                                    {processAnalysis.process_dependencies.map((dep, i) => (
                                                        <li key={i}>
                                                            {typeof dep === 'string' ? dep : (
                                                                <>
                                                                    <strong>{dep.upstream || dep.equipment}</strong> â†’ <strong>{dep.downstream || dep.dependency}</strong>: {dep.relationship || ''}
                                                                </>
                                                            )}
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {processAnalysis.process_gaps && processAnalysis.process_gaps.length > 0 && (
                                            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                                <h4 className="font-medium text-orange-800 mb-2"><i className="fas fa-exclamation-circle mr-2"></i>Identified Gaps (Missing Data)</h4>
                                                <ul className="text-sm text-orange-700 space-y-1 list-disc pl-5">
                                                    {processAnalysis.process_gaps.map((gap, i) => (
                                                        <li key={i}>{gap}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {processAnalysis.failure_patterns && Object.keys(processAnalysis.failure_patterns).length > 0 && (
                                            <div className="border rounded-lg overflow-hidden">
                                                <div className="bg-gray-50 p-3 border-b"><h4 className="font-medium"><i className="fas fa-exclamation-triangle mr-2 text-orange-500"></i>Typical Failure Patterns</h4></div>
                                                <div className="p-4 max-h-48 overflow-y-auto">
                                                    {Object.entries(processAnalysis.failure_patterns).slice(0, 5).map(([eqType, patterns], i) => (
                                                        <div key={i} className="mb-3 last:mb-0">
                                                            <h5 className="font-medium text-gray-700 text-sm">{eqType}</h5>
                                                            <ul className="text-xs text-gray-600 mt-1 space-y-1">
                                                                {Array.isArray(patterns) && patterns.slice(0, 3).map((p, j) => (
                                                                    <li key={j} className="flex items-start">
                                                                        <i className="fas fa-arrow-right text-gray-400 mr-2 mt-0.5"></i>
                                                                        <span><strong>{p.cause}:</strong> {p.consequence}</span>
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {processAnalysis.guidance_for_d_and_r && (
                                            <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                                <h4 className="font-medium text-indigo-800 mb-2"><i className="fas fa-lightbulb mr-2"></i>D&R Guidance</h4>
                                                <p className="text-sm text-indigo-700">{processAnalysis.guidance_for_d_and_r}</p>
                                            </div>
                                        )}

                                        {/* D&R Context Preview */}
                                        <div className="border border-gray-300 rounded-lg overflow-hidden">
                                            <div
                                                className="bg-gray-100 p-3 flex justify-between items-center cursor-pointer"
                                                onClick={() => setExpandedGroups(prev => ({ ...prev, 'dr-context-preview': !prev['dr-context-preview'] }))}
                                            >
                                                <h4 className="font-medium text-gray-700"><i className="fas fa-code mr-2"></i>Preview: What the D&R Agent Will See</h4>
                                                <i className={`fas fa-chevron-${expandedGroups['dr-context-preview'] ? 'up' : 'down'} text-gray-500`}></i>
                                            </div>
                                            {expandedGroups['dr-context-preview'] && (
                                                <div className="p-4 bg-gray-50">
                                                    <p className="text-xs text-gray-500 mb-2">This is the exact "Process Analysis Context" that will be injected into the AI prompt for drafting:</p>
                                                    <pre className="text-xs bg-white p-3 rounded border overflow-x-auto whitespace-pre-wrap font-mono text-gray-600">
                                                        {(() => {
                                                            let context = `Process Summary: ${processAnalysis.process_summary || 'Not available'}\n\n`;
                                                            if (processAnalysis.failure_patterns) {
                                                                context += `Typical Failure Patterns by Equipment Type:\n`;
                                                                Object.entries(processAnalysis.failure_patterns).forEach(([eqType, patterns]) => {
                                                                    context += `**${eqType}**:\n`;
                                                                    if (Array.isArray(patterns)) {
                                                                        patterns.forEach(p => {
                                                                            context += `- Cause: ${p.cause} â†’ Consequence: ${p.consequence}\n`;
                                                                        });
                                                                    }
                                                                });
                                                                context += '\n';
                                                            }
                                                            if (processAnalysis.guidance_for_d_and_r) {
                                                                context += `D&R Guidance:\n${processAnalysis.guidance_for_d_and_r}\n`;
                                                            }
                                                            return context;
                                                        })()}
                                                    </pre>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                        <i className="fas fa-info-circle text-3xl text-yellow-500 mb-2"></i>
                                        <p className="text-yellow-700">Process analysis not yet run. Click "Analyze Process" to start.</p>
                                        <button onClick={runProcessAnalysis} className="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                            <i className="fas fa-cogs mr-2"></i>Analyze Process
                                        </button>
                                    </div>
                                )}

                                <div className="flex justify-between">
                                    <button onClick={() => setStep(2)} className="text-gray-600"><i className="fas fa-arrow-left mr-2"></i>Back</button>
                                    <button onClick={() => { runConsistencyCheck(); setStep(4); }} disabled={!processAnalysis} className={`px-6 py-2 rounded-lg ${processAnalysis ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500'}`}>Next: Consistency Check <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <div className="space-y-6">
                                <div className="flex items-center justify-between">
                                    <h3 className="text-xl font-semibold">Step 4: Consistency Check</h3>
                                    <div className="flex items-center space-x-4">
                                        {/* Unit Filter */}
                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm text-gray-500">Unit:</span>
                                            <select
                                                value={selectedUnit}
                                                onChange={(e) => setSelectedUnit(e.target.value)}
                                                className="text-sm border rounded px-2 py-1 max-w-[150px]"
                                            >
                                                <option value="all">All Units</option>
                                                {uniqueUnits.map(u => (
                                                    <option key={u} value={u}>{u}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className="flex items-center space-x-2">
                                            <span className="text-sm text-gray-500">Sort by:</span>
                                            <select
                                                value={sortBy}
                                                onChange={(e) => setSortBy(e.target.value)}
                                                className="text-sm border rounded px-2 py-1"
                                            >
                                                <option value="alpha">Code Letter (A-Z)</option>
                                                <option value="todo">Todo Count (High-Low)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                {consistencyResults && <div className={`p-4 rounded-lg ${consistencyResults.groupsWithIssues > 0 ? 'bg-yellow-50' : 'bg-green-50'}`}><i className={`fas ${consistencyResults.groupsWithIssues > 0 ? 'fa-exclamation-triangle text-yellow-600' : 'fa-check-circle text-green-600'} mr-2`}></i>{consistencyResults.groupsWithIssues} groups with issues</div>}
                                <div className="space-y-2 max-h-80 overflow-y-auto">
                                    {sortedGroups.map((group, index) => {
                                        const prevGroup = sortedGroups[index - 1];
                                        const currentUnit = group.unit || 'Unknown Unit';
                                        const prevUnit = prevGroup ? (prevGroup.unit || 'Unknown Unit') : null;
                                        const isNewUnit = currentUnit !== prevUnit;
                                        return (
                                            <div key={group.codeLetter}>
                                                {isNewUnit && <h3 className="font-bold text-gray-800 bg-gray-100 px-2 py-1 rounded mb-2 mt-4 first:mt-0"><i className="fas fa-industry mr-2"></i>{currentUnit}</h3>}
                                                <div className="border rounded-lg">
                                                    <div className="flex items-center justify-between p-3 bg-gray-50 cursor-pointer" onClick={() => toggleGroup(group.codeLetter)}>
                                                        <div className="flex items-center">
                                                            <span className="font-mono font-bold text-indigo-600 mr-3">{group.displayName || group.codeLetter}</span>
                                                            <span className="text-sm mr-2">{group.alarms.length} alarms</span>
                                                            {getGroupSelectionState(group) !== 'none' && (
                                                                <span className={`text-xs px-2 py-0.5 rounded-full ${getGroupSelectionState(group) === 'all' ? 'bg-indigo-100 text-indigo-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                                    {group.alarms.filter(a => isAlarmSelected(a)).length} selected
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <button onClick={(e) => { e.stopPropagation(); selectGroupForDrafting(group); }} className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded mr-1 hover:bg-indigo-200">Select All</button>
                                                            <button onClick={(e) => { e.stopPropagation(); unselectGroupForDrafting(group); }} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded mr-2 hover:bg-red-100 hover:text-red-600">Unselect</button>
                                                            <i className={`fas fa-chevron-${expandedGroups[group.codeLetter] ? 'up' : 'down'}`}></i>
                                                        </div>
                                                    </div>
                                                    {expandedGroups[group.codeLetter] && (
                                                        <div className="p-2 text-xs max-h-96 overflow-y-auto border-t bg-white">
                                                            {Object.entries(group.alarms.reduce((acc, alarm) => {
                                                                const tag = alarm.Tag || alarm.tag || 'Unknown';
                                                                if (!acc[tag]) acc[tag] = [];
                                                                acc[tag].push(alarm);
                                                                return acc;
                                                            }, {})).map(([tag, tagAlarms]) => (
                                                                <div key={tag} className="mb-2 last:mb-0 border-b last:border-0 pb-2">
                                                                    <div className="flex items-center justify-between py-1 bg-gray-50 px-2 rounded mb-1">
                                                                        <div className="flex items-center">
                                                                            <input
                                                                                type="checkbox"
                                                                                checked={tagAlarms.every(a => isAlarmSelected(a))}
                                                                                onChange={(e) => {
                                                                                    e.stopPropagation();
                                                                                    const allSelected = tagAlarms.every(a => isAlarmSelected(a));
                                                                                    if (allSelected) {
                                                                                        // Deselect all
                                                                                        tagAlarms.forEach(a => {
                                                                                            if (isAlarmSelected(a)) toggleAlarmSelection(a);
                                                                                        });
                                                                                    } else {
                                                                                        // Select all
                                                                                        tagAlarms.forEach(a => {
                                                                                            if (!isAlarmSelected(a)) toggleAlarmSelection(a);
                                                                                        });
                                                                                    }
                                                                                }}
                                                                                className="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded cursor-pointer"
                                                                            />
                                                                            <span className="font-bold text-indigo-700 mr-2">{tag}</span>
                                                                            <span className="text-gray-500 text-[10px]">{tagAlarms.length} alarms</span>
                                                                        </div>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setExpandedGroups(prev => ({ ...prev, [`tag-${tag}`]: !prev[`tag-${tag}`] }));
                                                                            }}
                                                                            className="text-gray-400 hover:text-indigo-600 focus:outline-none"
                                                                        >
                                                                            <i className={`fas fa-chevron-${expandedGroups[`tag-${tag}`] ? 'up' : 'down'}`}></i>
                                                                        </button>
                                                                    </div>

                                                                    {/* Show alarms if tag expanded, default expanded? Maybe not to save space. Let's toggle. */}
                                                                    {expandedGroups[`tag-${tag}`] && (
                                                                        <div className="pl-6 space-y-1 mt-1">
                                                                            {tagAlarms.map((a, i) => (
                                                                                <div key={i} className={`flex items-center ${a._isComplete ? 'text-green-700' : 'text-blue-700'}`}>
                                                                                    <span className="text-xs truncate">{a.Alarm || a.alarm} - {a.Description || 'No Desc'}</span>
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="flex justify-between">
                                    <button onClick={() => setStep(3)} className="text-gray-600"><i className="fas fa-arrow-left mr-2"></i>Back</button>
                                    <button onClick={() => setStep(5)} className="bg-indigo-600 text-white px-6 py-2 rounded-lg">Next ({selectedForDrafting.length} selected) <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {step === 5 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold">Step 5: AI Drafting</h3>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4"><i className="fas fa-info-circle mr-2"></i>{selectedForDrafting.length} alarms selected (processing in batches of 10)</div>

                                {isProcessing ? (
                                    <div>
                                        <div className="w-full bg-gray-200 rounded-full h-4"><div className="bg-indigo-600 h-4 rounded-full transition-all" style={{ width: `${progress.percent}%` }}></div></div>
                                        <p className="text-center mt-2 text-indigo-600">{progress.message}</p>
                                    </div>
                                ) : draftResults.length > 0 ? (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        <h4 className="font-medium text-gray-700">Review AI-Generated Drafts:</h4>
                                        {draftResults.map((r, i) => (
                                            <div key={i} className={`border rounded-lg overflow-hidden ${r.success ? 'border-green-300' : 'border-red-300'}`}>
                                                <div className={`p-3 flex items-center justify-between cursor-pointer ${r.success ? 'bg-green-50' : 'bg-red-50'}`} onClick={() => setExpandedGroups(prev => ({ ...prev, [`draft-${i}`]: !prev[`draft-${i}`] }))}>
                                                    <div className="flex items-center flex-1">
                                                        <span className="font-mono font-bold mr-2">{r.fullAlarmName || window.drProcessor.getFullAlarmName(r.alarm)}</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        {r.success ? <span className="text-green-600 text-sm mr-2"><i className="fas fa-check-circle"></i> Drafted</span> : <span className="text-red-600 text-sm mr-2"><i className="fas fa-times-circle"></i> {r.error}</span>}
                                                        <i className={`fas fa-chevron-${expandedGroups[`draft-${i}`] ? 'up' : 'down'} text-gray-400`}></i>
                                                    </div>
                                                </div>
                                                {expandedGroups[`draft-${i}`] && r.success && (
                                                    <div className="p-4 bg-white border-t">
                                                        <p className="text-xs text-gray-500 mb-3">Description: {r.alarm.Description || ''}</p>
                                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                                            <div><span className="font-medium text-gray-700">Cause:</span><p className="mt-1 text-gray-600">{r.draft.Cause}</p></div>
                                                            <div><span className="font-medium text-gray-700">Consequence:</span><p className="mt-1 text-gray-600">{r.draft.Consequence}</p></div>
                                                            <div><span className="font-medium text-gray-700">Corrective Action:</span><p className="mt-1 text-gray-600">{r.draft['Corrective Action']}</p></div>
                                                            <div><span className="font-medium text-gray-700">Proposed Priority:</span><p className="mt-1"><span className={`px-2 py-1 rounded text-xs ${r.draft['Proposed Priority']?.includes('1') || r.draft['Proposed Priority']?.toLowerCase().includes('urgent') || r.draft['Proposed Priority']?.toLowerCase().includes('critical') ? 'bg-red-100 text-red-700' : r.draft['Proposed Priority']?.includes('2') || r.draft['Proposed Priority']?.toLowerCase().includes('high') ? 'bg-orange-100 text-orange-700' : r.draft['Proposed Priority']?.toLowerCase().includes('remove') ? 'bg-gray-100 text-gray-700' : 'bg-blue-100 text-blue-700'}`}>{r.draft['Proposed Priority']}</span></p></div>
                                                            <div><span className="font-medium text-gray-700">Max Time to Respond:</span><p className="mt-1 text-gray-600">{r.draft['Max Time to Respond']}</p></div>
                                                        </div>
                                                        {r.draft['AI Reasoning'] && (
                                                            <div className="mt-3 p-2 bg-indigo-50 rounded text-sm"><i className="fas fa-lightbulb text-indigo-600 mr-2"></i><span className="font-medium">AI Reasoning:</span> {r.draft['AI Reasoning']}</div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <button onClick={runAIDrafting} disabled={selectedForDrafting.length === 0} className="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"><i className="fas fa-robot mr-2"></i>Start AI Drafting (Batch Mode)</button>
                                )}

                                <div className="flex justify-between">
                                    <button onClick={() => setStep(4)} className="text-gray-600 hover:text-gray-800"><i className="fas fa-arrow-left mr-2"></i>Back</button>
                                    <button onClick={runComplianceCheck} disabled={draftResults.length === 0} className={`px-6 py-2 rounded-lg ${draftResults.length > 0 ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-300 text-gray-500'}`}>Next: Compliance Check <i className="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </div>
                        )}

                        {step === 6 && (
                            <div className="space-y-6">
                                <h3 className="text-xl font-semibold text-green-600"><i className="fas fa-check-circle mr-2"></i>Step 6: Review & Export</h3>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-blue-50 p-4 rounded-lg text-center border border-blue-200"><p className="text-sm text-blue-600 font-medium">Total Records</p><p className="text-2xl font-bold text-blue-800">{madbData.length}</p></div>
                                    <div className="bg-green-50 p-4 rounded-lg text-center border border-green-200"><p className="text-sm text-green-600 font-medium">AI Drafted</p><p className="text-2xl font-bold text-green-800">{draftResults.filter(r => r.success).length}</p></div>
                                </div>



                                {/* Priority Analysis Dashboard */}
                                {draftResults.filter(r => r.success).length > 0 && (() => {
                                    const analysis = window.drProcessor.analyzePriorityChanges(draftResults, madbData);
                                    const distribution = window.drProcessor.analyzePriorityDistribution(draftResults, madbData);

                                    // Helper to categorize priority for filtering
                                    const categorizePriority = (priority) => {
                                        if (!priority) return 'None/Remove';
                                        const p = priority.toString().replace(/^AI:\s*/i, '').toLowerCase().trim();
                                        if (p.includes('1') || p.includes('urgent') || p.includes('critical') || p.includes('emergency')) return 'Urgent';
                                        if (p.includes('2') || p === 'high') return 'High';
                                        if (p.includes('3') || p === 'medium') return 'Medium';
                                        if (p === 'low' || p.includes('4')) return 'Low';
                                        if (p.includes('diagnostic') || p.includes('journal') || p.includes('log')) return 'Diagnostic';
                                        if (p.includes('none') || p.includes('remove') || p === 'no alarm') return 'None/Remove';
                                        return 'Medium';
                                    };

                                    const filteredDetails = analysis.details.filter(d => {
                                        // First apply direction filter
                                        let passesDirectionFilter = true;
                                        if (priorityFilter !== 'all') {
                                            if (priorityFilter === 'changed') {
                                                passesDirectionFilter = d.direction === 'increased' || d.direction === 'decreased';
                                            } else {
                                                passesDirectionFilter = d.direction === priorityFilter;
                                            }
                                        }

                                        // Then apply distribution priority filter (from chart click)
                                        let passesDistributionFilter = true;
                                        if (distributionPriorityFilter) {
                                            // Compare with source priority directly (strip AI prefix)
                                            const proposedPriorityClean = (d.proposedPriority || '').toString().replace(/^AI:\s*/i, '').trim();
                                            passesDistributionFilter = proposedPriorityClean === distributionPriorityFilter;
                                        }

                                        return passesDirectionFilter && passesDistributionFilter;
                                    });
                                    return (
                                        <div className="border border-indigo-200 rounded-lg overflow-hidden">
                                            <div className="bg-indigo-50 p-3 border-b border-indigo-200">
                                                <h4 className="font-medium text-indigo-800"><i className="fas fa-chart-bar mr-2"></i>Priority Analysis</h4>
                                            </div>
                                            <div className="p-4">
                                                {/* Summary Cards */}
                                                <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4">
                                                    <div className="bg-gray-50 p-3 rounded-lg text-center border">
                                                        <p className="text-xs text-gray-600 font-medium">Total</p>
                                                        <p className="text-xl font-bold text-gray-800">{analysis.total}</p>
                                                    </div>
                                                    <div className="bg-yellow-50 p-3 rounded-lg text-center border border-yellow-200 cursor-pointer hover:bg-yellow-100" onClick={() => setPriorityFilter(priorityFilter === 'changed' ? 'all' : 'changed')}>
                                                        <p className="text-xs text-yellow-600 font-medium">Changed</p>
                                                        <p className="text-xl font-bold text-yellow-800">{analysis.changed}</p>
                                                    </div>
                                                    <div className="bg-gray-50 p-3 rounded-lg text-center border cursor-pointer hover:bg-gray-100" onClick={() => setPriorityFilter(priorityFilter === 'unchanged' ? 'all' : 'unchanged')}>
                                                        <p className="text-xs text-gray-600 font-medium">Unchanged</p>
                                                        <p className="text-xl font-bold text-gray-800">{analysis.unchanged}</p>
                                                    </div>
                                                    <div className="bg-red-50 p-3 rounded-lg text-center border border-red-200 cursor-pointer hover:bg-red-100" onClick={() => setPriorityFilter(priorityFilter === 'increased' ? 'all' : 'increased')}>
                                                        <p className="text-xs text-red-600 font-medium">â†‘ Increased</p>
                                                        <p className="text-xl font-bold text-red-800">{analysis.increased}</p>
                                                    </div>
                                                    <div className="bg-green-50 p-3 rounded-lg text-center border border-green-200 cursor-pointer hover:bg-green-100" onClick={() => setPriorityFilter(priorityFilter === 'decreased' ? 'all' : 'decreased')}>
                                                        <p className="text-xs text-green-600 font-medium">â†“ Decreased</p>
                                                        <p className="text-xl font-bold text-green-800">{analysis.decreased}</p>
                                                    </div>
                                                </div>
                                                {/* Filter indicator */}
                                                {(priorityFilter !== 'all' || distributionPriorityFilter) && (
                                                    <div className="mb-2 flex items-center text-sm flex-wrap gap-2">
                                                        {priorityFilter !== 'all' && (
                                                            <span className="text-gray-500">Direction: <strong className="text-indigo-600">{priorityFilter}</strong></span>
                                                        )}
                                                        {distributionPriorityFilter && (
                                                            <span className="text-gray-500">Priority: <strong className="text-indigo-600">{distributionPriorityFilter}</strong></span>
                                                        )}
                                                        <button onClick={() => { setPriorityFilter('all'); setDistributionPriorityFilter(null); }} className="text-xs text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i> Clear All</button>
                                                    </div>
                                                )}
                                                {/* Details Table */}
                                                <div className="max-h-64 overflow-y-auto border rounded">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-gray-100 sticky top-0">
                                                            <tr>
                                                                <th className="text-left p-2 font-medium">Tag</th>
                                                                <th className="text-left p-2 font-medium">Description</th>
                                                                <th className="text-left p-2 font-medium">Current</th>
                                                                <th className="text-center p-2 font-medium">â†’</th>
                                                                <th className="text-left p-2 font-medium">Proposed</th>
                                                                <th className="text-center p-2 font-medium">Î”</th>
                                                                <th className="text-left p-2 font-medium">AI Reasoning</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {filteredDetails.map((item, i) => (
                                                                <tr key={i} className={`border-t ${item.direction === 'increased' ? 'bg-red-50' : item.direction === 'decreased' ? 'bg-green-50' : ''}`}>
                                                                    <td className="p-2 font-mono text-xs max-w-32 truncate" title={item.fullAlarmName}>{item.fullAlarmName}</td>
                                                                    <td className="p-2 text-xs text-gray-600 max-w-40 truncate" title={item.description}>{item.description || '-'}</td>
                                                                    <td className="p-2 text-xs">{item.currentPriority}</td>
                                                                    <td className="p-2 text-center text-gray-400">â†’</td>
                                                                    <td className="p-2 text-xs">{item.proposedPriority}</td>
                                                                    <td className="p-2 text-center">
                                                                        {item.direction === 'increased' && <span className="text-red-600 font-bold">â†‘</span>}
                                                                        {item.direction === 'decreased' && <span className="text-green-600 font-bold">â†“</span>}
                                                                        {item.direction === 'unchanged' && <span className="text-gray-400">=</span>}
                                                                        {item.direction === 'unknown' && <span className="text-gray-300">?</span>}
                                                                    </td>
                                                                    <td className="p-2 text-xs text-gray-600 max-w-xs" title={item.aiReasoning}>
                                                                        <div className="line-clamp-2">{item.aiReasoning || '-'}</div>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}

                                {/* Priority Distribution Chart */}
                                {draftResults.filter(r => r.success).length > 0 && (() => {
                                    const dist = window.drProcessor.analyzePriorityDistribution(draftResults, madbData);
                                    const maxCount = Math.max(...dist.categories.map(cat => Math.max(dist.beforeCounts[cat] || 0, dist.afterCounts[cat] || 0)), 1);

                                    // Dynamic color assignment based on priority name
                                    const getColorForCategory = (cat) => {
                                        const catLower = cat.toLowerCase();
                                        if (catLower.includes('urgent') || catLower.includes('critical') || catLower.includes('emergency'))
                                            return { bg: 'bg-red-500', hover: 'hover:bg-red-600', light: 'bg-red-200' };
                                        if (catLower.includes('high'))
                                            return { bg: 'bg-orange-500', hover: 'hover:bg-orange-600', light: 'bg-orange-200' };
                                        if (catLower.includes('medium'))
                                            return { bg: 'bg-yellow-500', hover: 'hover:bg-yellow-600', light: 'bg-yellow-200' };
                                        if (catLower.includes('low'))
                                            return { bg: 'bg-blue-500', hover: 'hover:bg-blue-600', light: 'bg-blue-200' };
                                        if (catLower.includes('diagnostic') || catLower.includes('log'))
                                            return { bg: 'bg-purple-500', hover: 'hover:bg-purple-600', light: 'bg-purple-200' };
                                        if (catLower.includes('none') || catLower.includes('remove') || catLower.includes('not set'))
                                            return { bg: 'bg-gray-500', hover: 'hover:bg-gray-600', light: 'bg-gray-200' };
                                        return { bg: 'bg-indigo-500', hover: 'hover:bg-indigo-600', light: 'bg-indigo-200' };
                                    };

                                    // Helper to categorize priority for 80-15-5 calculation
                                    const categorizeFor80_15_5 = (cat) => {
                                        const catLower = cat.toLowerCase();
                                        if (catLower.includes('urgent') || catLower.includes('critical') || catLower.includes('emergency') || catLower.includes('high')) return 'high';
                                        if (catLower.includes('medium')) return 'medium';
                                        return 'low'; // low, diagnostic, none, etc.
                                    };

                                    // 80-15-5 Rule Calculation
                                    const totalAfter = Object.values(dist.afterCounts).reduce((a, b) => a + b, 0);
                                    const totalBefore = Object.values(dist.beforeCounts).reduce((a, b) => a + b, 0);

                                    // Map source categories to 80-15-5 tiers dynamically
                                    let highTierAfter = 0, mediumTierAfter = 0, lowTierAfter = 0;
                                    let highTierBefore = 0, mediumTierBefore = 0, lowTierBefore = 0;
                                    dist.categories.forEach(cat => {
                                        const tier = categorizeFor80_15_5(cat);
                                        if (tier === 'high') {
                                            highTierAfter += (dist.afterCounts[cat] || 0);
                                            highTierBefore += (dist.beforeCounts[cat] || 0);
                                        } else if (tier === 'medium') {
                                            mediumTierAfter += (dist.afterCounts[cat] || 0);
                                            mediumTierBefore += (dist.beforeCounts[cat] || 0);
                                        } else {
                                            lowTierAfter += (dist.afterCounts[cat] || 0);
                                            lowTierBefore += (dist.beforeCounts[cat] || 0);
                                        }
                                    });

                                    const highPctAfter = totalAfter > 0 ? ((highTierAfter / totalAfter) * 100).toFixed(0) : 0;
                                    const mediumPctAfter = totalAfter > 0 ? ((mediumTierAfter / totalAfter) * 100).toFixed(0) : 0;
                                    const lowPctAfter = totalAfter > 0 ? ((lowTierAfter / totalAfter) * 100).toFixed(0) : 0;

                                    const highPctBefore = totalBefore > 0 ? ((highTierBefore / totalBefore) * 100).toFixed(0) : 0;
                                    const mediumPctBefore = totalBefore > 0 ? ((mediumTierBefore / totalBefore) * 100).toFixed(0) : 0;
                                    const lowPctBefore = totalBefore > 0 ? ((lowTierBefore / totalBefore) * 100).toFixed(0) : 0;

                                    // Calculate compliance score (how close to 80-15-5)
                                    const calcCompliance = (high, medium, low) => {
                                        const highDev = Math.abs(high - 5);
                                        const mediumDev = Math.abs(medium - 15);
                                        const lowDev = Math.abs(low - 80);
                                        const totalDev = highDev + mediumDev + lowDev;
                                        return Math.max(0, 100 - totalDev).toFixed(0);
                                    };

                                    const complianceBefore = calcCompliance(highPctBefore, mediumPctBefore, lowPctBefore);
                                    const complianceAfter = calcCompliance(highPctAfter, mediumPctAfter, lowPctAfter);
                                    const complianceImproved = parseInt(complianceAfter) > parseInt(complianceBefore);

                                    return (
                                        <div className="border border-green-200 rounded-lg overflow-hidden">
                                            <div className="bg-green-50 p-3 border-b border-green-200 flex justify-between items-center">
                                                <div>
                                                    <h4 className="font-medium text-green-800"><i className="fas fa-chart-bar mr-2"></i>Priority Distribution ({totalAfter} alarms)</h4>
                                                    {dist.excludedCount > 0 && <span className="text-xs text-orange-600 ml-2"><i className="fas fa-info-circle mr-1"></i>{dist.excludedCount} Journal/None alarm(s) excluded</span>}
                                                </div>
                                                <div className="flex items-center gap-4 text-xs">
                                                    <span className="flex items-center"><span className="w-3 h-3 bg-gray-400 rounded mr-1"></span> Current</span>
                                                    <span className="flex items-center"><span className="w-3 h-3 bg-indigo-500 rounded mr-1"></span> Proposed</span>
                                                </div>
                                            </div>
                                            <div className="p-4">
                                                {/* 80-15-5 Rule Compliance Card */}
                                                <div className="mb-4 p-3 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <i className="fas fa-balance-scale text-indigo-600"></i>
                                                            <span className="text-sm font-medium text-indigo-800">80/15/5 Rule Compliance</span>
                                                            <span className="text-xs text-gray-500">(ISA-18.2 / EEMUA 191)</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <div className="text-center">
                                                                <div className="text-xs text-gray-500">Before</div>
                                                                <div className={`text-lg font-bold ${complianceBefore >= 70 ? 'text-green-600' : complianceBefore >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>{complianceBefore}%</div>
                                                            </div>
                                                            <i className={`fas fa-arrow-right ${complianceImproved ? 'text-green-500' : 'text-gray-400'}`}></i>
                                                            <div className="text-center">
                                                                <div className="text-xs text-gray-500">After</div>
                                                                <div className={`text-lg font-bold ${complianceAfter >= 70 ? 'text-green-600' : complianceAfter >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>{complianceAfter}%</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2 text-xs">
                                                        <div className="bg-white p-2 rounded border text-center">
                                                            <div className="flex items-center justify-center gap-1 mb-1">
                                                                <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                                                                <span className="font-medium text-gray-700">High/Critical</span>
                                                            </div>
                                                            <div className="text-gray-500">Target: <span className="font-bold text-gray-700">5%</span></div>
                                                            <div className="flex justify-center gap-2 mt-1">
                                                                <span className={parseInt(highPctBefore) <= 10 ? 'text-green-600' : 'text-red-600'}>{highPctBefore}%</span>
                                                                <span className="text-gray-400">â†’</span>
                                                                <span className={`font-medium ${parseInt(highPctAfter) <= 10 ? 'text-green-600' : 'text-red-600'}`}>{highPctAfter}%</span>
                                                            </div>
                                                        </div>
                                                        <div className="bg-white p-2 rounded border text-center">
                                                            <div className="flex items-center justify-center gap-1 mb-1">
                                                                <span className="w-2 h-2 bg-yellow-500 rounded-full"></span>
                                                                <span className="font-medium text-gray-700">Medium</span>
                                                            </div>
                                                            <div className="text-gray-500">Target: <span className="font-bold text-gray-700">15%</span></div>
                                                            <div className="flex justify-center gap-2 mt-1">
                                                                <span className={Math.abs(parseInt(mediumPctBefore) - 15) <= 10 ? 'text-green-600' : 'text-yellow-600'}>{mediumPctBefore}%</span>
                                                                <span className="text-gray-400">â†’</span>
                                                                <span className={`font-medium ${Math.abs(parseInt(mediumPctAfter) - 15) <= 10 ? 'text-green-600' : 'text-yellow-600'}`}>{mediumPctAfter}%</span>
                                                            </div>
                                                        </div>
                                                        <div className="bg-white p-2 rounded border text-center">
                                                            <div className="flex items-center justify-center gap-1 mb-1">
                                                                <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                                                                <span className="font-medium text-gray-700">Low/Advisory</span>
                                                            </div>
                                                            <div className="text-gray-500">Target: <span className="font-bold text-gray-700">80%</span></div>
                                                            <div className="flex justify-center gap-2 mt-1">
                                                                <span className={parseInt(lowPctBefore) >= 60 ? 'text-green-600' : 'text-red-600'}>{lowPctBefore}%</span>
                                                                <span className="text-gray-400">â†’</span>
                                                                <span className={`font-medium ${parseInt(lowPctAfter) >= 60 ? 'text-green-600' : 'text-red-600'}`}>{lowPctAfter}%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Bar Chart */}
                                                <div className="space-y-3">
                                                    {dist.categories.map(cat => {
                                                        const beforePct = ((dist.beforeCounts[cat] || 0) / maxCount) * 100;
                                                        const afterPct = ((dist.afterCounts[cat] || 0) / maxCount) * 100;
                                                        const colors = getColorForCategory(cat);
                                                        const isSelected = distributionPriorityFilter === cat;
                                                        return (
                                                            <div key={cat} className="flex items-center gap-2">
                                                                <div className="w-24 text-xs font-medium text-gray-700 text-right">{cat}</div>
                                                                <div className="flex-1 flex gap-1">
                                                                    {/* Before bar */}
                                                                    <div className="flex-1 h-6 bg-gray-100 rounded relative cursor-pointer" onClick={() => setDistributionPriorityFilter(isSelected ? null : cat)} title={`Current: ${dist.beforeCounts[cat] || 0} alarms. Click to filter.`}>
                                                                        <div className={`h-full bg-gray-400 rounded transition-all ${isSelected ? 'ring-2 ring-indigo-400' : ''}`} style={{ width: `${beforePct}%` }}></div>
                                                                        {(dist.beforeCounts[cat] || 0) > 0 && <span className="absolute left-1 top-1/2 -translate-y-1/2 text-xs text-white font-medium">{dist.beforeCounts[cat]}</span>}
                                                                    </div>
                                                                    {/* After bar */}
                                                                    <div className={`flex-1 h-6 ${colors.light} rounded relative cursor-pointer ${colors.hover}`} onClick={() => setDistributionPriorityFilter(isSelected ? null : cat)} title={`Proposed: ${dist.afterCounts[cat] || 0} alarms. Click to filter.`}>
                                                                        <div className={`h-full ${colors.bg} rounded transition-all ${isSelected ? 'ring-2 ring-indigo-400' : ''}`} style={{ width: `${afterPct}%` }}></div>
                                                                        {(dist.afterCounts[cat] || 0) > 0 && <span className="absolute left-1 top-1/2 -translate-y-1/2 text-xs text-white font-medium">{dist.afterCounts[cat]}</span>}
                                                                    </div>
                                                                </div>
                                                                <div className="w-20 text-xs text-gray-500">
                                                                    {dist.beforeCounts[cat] !== dist.afterCounts[cat] ? (
                                                                        <span className={dist.afterCounts[cat] > dist.beforeCounts[cat] ? 'text-orange-600' : 'text-green-600'}>
                                                                            {dist.afterCounts[cat] > dist.beforeCounts[cat] ? '+' : ''}{dist.afterCounts[cat] - dist.beforeCounts[cat]}
                                                                        </span>
                                                                    ) : <span className="text-gray-400">â€”</span>}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <p className="text-xs text-gray-500 mt-3 text-center">Click any bar to filter the Priority Analysis table above</p>
                                            </div>
                                        </div>
                                    );
                                })()}

                                <div className="flex flex-col space-y-3">
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={exportDataCSV} className="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 flex items-center justify-center"><i className="fas fa-file-csv mr-2"></i>Export CSV (Selected Only)</button>
                                        <button onClick={exportDataJSON} className="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center"><i className="fas fa-file-code mr-2"></i>Export JSON (Selected Only)</button>
                                    </div>
                                    <p className="text-xs text-gray-500 text-center">Only the {draftResults.filter(r => r.success).length} drafted alarms will be exported with AI-generated fields.</p>
                                </div>

                                <button onClick={handleNewRun} className="bg-red-50 text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-100 text-sm font-medium transition-colors mt-2">
                                    <i className="fas fa-redo mr-2"></i>New D&R Run
                                </button>
                            </div>
                        )}

                        <div className="mt-4 border-t pt-3"><button className="text-sm text-gray-500" onClick={() => document.getElementById('ai-dr-logs').classList.toggle('hidden')}><i className="fas fa-terminal mr-2"></i>Logs</button><div id="ai-dr-logs" className="hidden mt-2 bg-gray-900 text-green-400 p-2 rounded h-24 overflow-y-auto font-mono text-xs">{logs.map((l, i) => <div key={i}>{l}</div>)}</div></div>

                        {/* AI Rationalization Info Modal */}
                        {showInfoModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={() => setShowInfoModal(false)}>
                                <div className="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                    <div className="p-4 border-b bg-indigo-50 flex justify-between items-center sticky top-0">
                                        <h3 className="text-lg font-bold text-indigo-800"><i className="fas fa-brain mr-2"></i>How AI Rationalization Works</h3>
                                        <button onClick={() => setShowInfoModal(false)} className="text-gray-500 hover:text-gray-700"><i className="fas fa-times"></i></button>
                                    </div>
                                    <div className="p-5 space-y-4 text-sm">
                                        <div>
                                            <h4 className="font-semibold text-gray-800 mb-2"><i className="fas fa-cogs text-indigo-500 mr-2"></i>ISA 18.2 Compliance</h4>
                                            <p className="text-gray-600">The AI follows ISA 18.2 / IEC 62682 standards for alarm rationalization. Each alarm is evaluated for its actionability, urgency, and consequence severity.</p>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-gray-800 mb-2"><i className="fas fa-project-diagram text-green-500 mr-2"></i>Vendor-Specific Presets</h4>
                                            <p className="text-gray-600 mb-2">The AI applies D&R presets based on your control system vendor:</p>
                                            <ul className="list-disc pl-5 text-gray-600 space-y-1">
                                                <li><strong>Foxboro I/A:</strong> HHABS/LLABS removed, RATE alarms removed, IOBAD set to Diagnostic</li>
                                                <li><strong>Yokogawa CENTUM:</strong> HH/LL set to Log, VEL/DV alarms disabled</li>
                                                <li><strong>DeltaV:</strong> Deviation alarms removed, Rate of Change removed</li>
                                                <li><strong>Wonderware:</strong> ROC/MAJDEV/MINDEV removed, LOLO/HIHI disabled unless distinct action</li>
                                                <li><strong>Honeywell TPS/Experion:</strong> PVHH/PVLL/DEVHI/DEVLO set to NOACTION</li>
                                                <li><strong>Emerson Ovation:</strong> Only H1/L1 used, Better/Worse/Return alarms NOT used</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-gray-800 mb-2"><i className="fas fa-table text-orange-500 mr-2"></i>Risk Matrix</h4>
                                            <p className="text-gray-600">Priority is determined by crossing Consequence Severity with Time to Respond. Critical alarms require action within 5 minutes; Low priority allows up to 60 minutes.</p>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold text-gray-800 mb-2"><i className="fas fa-file-export text-blue-500 mr-2"></i>Output Fields</h4>
                                            <p className="text-gray-600">The AI generates: <strong>Cause</strong>, <strong>Consequence</strong>, <strong>Corrective Action</strong>, <strong>Recommended Priority</strong>, <strong>Max Time to Respond</strong>, and <strong>Reasoning</strong> (citing the vendor rule used).</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const handleCancelMapping = () => {

                setShowColumnMapping(false);
                setRawCsvData(null);
                setColumnAnalysis(null);
                setUploadedFileName('');
            };

            // --- CHATBOT HANDLERS ---
            const handleChatSubmit = async (e) => {
                e?.preventDefault();
                if (!chatInput.trim()) return;

                const userMessage = {
                    id: Date.now(),
                    role: 'user',
                    content: chatInput,
                    timestamp: new Date()
                };

                setChatMessages(prev => [...prev, userMessage]);
                setChatInput('');
                setIsTyping(true);

                try {
                    const history = chatMessages.slice(-10).map(msg => ({
                        role: msg.role,
                        content: msg.content
                    }));

                    const response = await window.chatbotService.sendMessage(
                        userMessage.content,
                        null,
                        history
                    );

                    if (response.type === 'error') {
                        throw new Error(response.error);
                    }

                    setChatMessages(prev => [...prev, {
                        id: Date.now(),
                        role: 'assistant',
                        content: response.text,
                        thoughts: response.thoughts,
                        timestamp: new Date()
                    }]);
                } catch (error) {
                    console.error('Chatbot error:', error);
                    setChatMessages(prev => [...prev, {
                        id: Date.now(),
                        role: 'assistant',
                        content: `I encountered an error: ${error.message}. Please check the configuration and try again.`,
                        timestamp: new Date(),
                        isError: true
                    }]);
                } finally {
                    setIsTyping(false);
                }
            };

            const handleClearChat = () => {
                setChatMessages([{
                    id: Date.now(),
                    role: 'assistant',
                    content: 'Chat cleared. How can I help you analyze your alarm data?',
                    timestamp: new Date()
                }]);
                setSelectedChatSession(null);
            };

            const handleSuggestionClick = (suggestion) => {
                setChatInput(suggestion);
            };

            const saveChatbotSettings = () => {
                console.log('Saving chatbot settings:', chatbotSettings);
                window.chatbotService.saveConfig(chatbotSettings);
                setChatbotConfigured(window.chatbotService.isConfigured());
                alert('Chatbot settings saved successfully!');
            };

            const analyzeSessionInChat = (session) => {
                setSelectedChatSession(session);
                const alarmList = session.events
                    .filter(e => e.isAlarm)
                    .map(e => e.tag)
                    .slice(0, 5)
                    .join(', ');

                const suggestion = `Analyze session ${session.id} with alarms: ${alarmList}`;
                setChatInput(suggestion);
                setActiveTab('assistant');
            };

            // --- MACHINE LEARNING HANDLERS ---
            const handleLoadModel = async () => {
                const loadedModel = await window.mlService.loadSavedModel();
                if (loadedModel) {
                    setModel(loadedModel);
                    setModelStatus('trained');
                }
            };

            const handleTrainModel = async () => {
                if (!validSessions || validSessions.length === 0) return;

                setModelStatus('training');
                setTrainingProgress({ epoch: 0, totalEpochs: trainingEpochs });

                try {
                    const onEpochEnd = (epoch, logs) => {
                        setTrainingProgress({
                            epoch: epoch + 1,
                            totalEpochs: trainingEpochs,
                            loss: logs.loss,
                            accuracy: logs.acc,
                            valLoss: logs.val_loss,
                            valAccuracy: logs.val_acc
                        });
                    };

                    const trainedModel = await window.mlService.trainModel(validSessions, data, trainingEpochs, onEpochEnd);
                    setModel(trainedModel);
                    setModelStatus('trained');
                    alert('Model trained successfully!');
                } catch (error) {
                    console.error('Training error:', error);
                    alert('Training failed: ' + error.message);
                    setModelStatus('untrained');
                }
            };

            const handleDeleteModel = async () => {
                await window.mlService.deleteSavedModel();
                setModel(null);
                setModelStatus('untrained');
            };

            const handlePredictEvents = () => {
                if (!model || !queryInput) return;

                const lastTag = queryInput.split(',').map(tag => tag.trim()).pop();

                const mlResults = window.mlService.predictNextEvents(model, queryInput);
                const commonResponse = window.mlService.findCommonResponses(lastTag, validSessions);
                const optimalResponse = window.mlService.findBestOperatorResponses(lastTag, validSessions);

                setPredictionResults({ ...mlResults, commonResponse, optimalResponse });
            };

            // --- PROCESS MINING HANDLERS ---
            const getUniqueEventId = (event) => {
                if (!event || !event.tag) return 'UNKNOWN';
                if (event.isAlarm) return `[A] ${event.tag}`;
                if (event.isChange) return `[C] ${event.tag}`;
                return `[E] ${event.tag}`;
            };

            const applyProcessFilters = () => {
                if (!validSessions) return;

                let filteredSessions = validSessions;

                if (processFilters.unit !== 'all') {
                    filteredSessions = filteredSessions.filter(session => session.unit === processFilters.unit);
                }

                if (processFilters.selectedSession !== null && processFilters.selectedSession !== '') {
                    const sessionId = typeof processFilters.selectedSession === 'string' ?
                        parseInt(processFilters.selectedSession) : processFilters.selectedSession;

                    filteredSessions = filteredSessions.filter(session => session.id === sessionId);
                } else {
                    if (processFilters.timeRange.start && processFilters.timeRange.end) {
                        filteredSessions = filteredSessions.filter(session =>
                            session.startTime >= processFilters.timeRange.start && session.endTime <= processFilters.timeRange.end
                        );
                    }

                    if (processFilters.startingAlarm) {
                        filteredSessions = filteredSessions.filter(session => {
                            if (session.events.length === 0) return false;
                            const firstEventId = getUniqueEventId(session.events[0]);
                            return firstEventId === processFilters.startingAlarm;
                        });
                    }

                    if (processFilters.containsAlarm) {
                        filteredSessions = filteredSessions.filter(session =>
                            session.events.some(event => event.tag === processFilters.containsAlarm && event.isAlarm)
                        );
                    }
                }

                const graph = window.processMiningService.buildProcessGraph(
                    filteredSessions.slice(0, 500),
                    heuristicFilters
                );
                setFilteredProcessGraph(graph);

                const { dfg, dfgVisual, stats } = window.processMiningService.createDFG(filteredSessions);
                setDfgData({ dfg, dfgVisual });
                setProcessStats(stats);
            };

            const handleResetFilters = () => {
                setProcessFilters({
                    timeRange: { start: null, end: null },
                    selectedSession: null,
                    startingAlarm: '',
                    containsAlarm: '',
                    unit: 'all',
                    maxNodes: 50,
                    minFrequency: 0.02
                });
                setHeuristicFilters({
                    dependencyThreshold: 0.5,
                    frequencyThreshold: 0.02,
                    showLoops: true,
                    showParallel: true
                });
                setFilteredProcessGraph(null);
                setDfgData(null);
                setProcessStats(null);
            };

            const showSessionInProcessMining = (session) => {
                const newFilters = {
                    ...processFilters,
                    selectedSession: session.id,
                    startingAlarm: '',
                    containsAlarm: '',
                    timeRange: { start: null, end: null },
                    unit: 'all'
                };
                setProcessFilters(newFilters);
                setNeedsProcessUpdate(true);
                setActiveTab('process');
            };

            const showVariantInProcessMining = (variant) => {
                const firstEvent = variant.events[0];
                const newFilters = {
                    ...processFilters,
                    selectedSession: null,
                    startingAlarm: firstEvent,
                    containsAlarm: ''
                };
                setProcessFilters(newFilters);
                setNeedsProcessUpdate(true);
                setActiveTab('process');
            };

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    networkContainerRef.current?.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            };


            // --- RATIONALIZATION HANDLERS ---
            const handleRationalizationDecision = (alarmTag, decision) => {
                setRationalizationDecisions(prev => ({
                    ...prev,
                    [alarmTag]: {
                        decision,
                        timestamp: new Date().toISOString(),
                        implementationStatus: 'pending'
                    }
                }));
                alert(`Decision recorded for ${alarmTag}: ${decision}`);
            };

            const [rationalizationFilter, setRationalizationFilter] = React.useState('all');
            const [scoreRangeFilter, setScoreRangeFilter] = React.useState(null);
            const [selectedAlarmForReview, setSelectedAlarmForReview] = React.useState(null);

            const filteredNuisanceAlarms = nuisanceAlarms.filter(alarm => {
                const passesRecommendationFilter = rationalizationFilter === 'all' || alarm.recommendation === rationalizationFilter;

                let passesScoreFilter = true;
                if (scoreRangeFilter) {
                    if (scoreRangeFilter === '0-20') passesScoreFilter = alarm.nuisanceScore <= 20;
                    else if (scoreRangeFilter === '21-40') passesScoreFilter = alarm.nuisanceScore > 20 && alarm.nuisanceScore <= 40;
                    else if (scoreRangeFilter === '41-60') passesScoreFilter = alarm.nuisanceScore > 40 && alarm.nuisanceScore <= 60;
                    else if (scoreRangeFilter === '61-80') passesScoreFilter = alarm.nuisanceScore > 60 && alarm.nuisanceScore <= 80;
                    else if (scoreRangeFilter === '81-100') passesScoreFilter = alarm.nuisanceScore > 80;
                }

                return passesRecommendationFilter && passesScoreFilter;
            });

            const filteredSessions = validSessions.filter(session => {
                const passesUnitFilter = sessionFilters.unit === 'all' || session.unit === sessionFilters.unit;
                const passesDurationFilter = session.duration >= sessionFilters.minDuration * 60 * 1000;
                const passesAlarmFilter = session.alarms >= sessionFilters.minAlarms;
                const passesContainsAlarmFilter = sessionFilters.containsAlarm === '' ||
                    session.events.some(event => event.tag === sessionFilters.containsAlarm && event.isAlarm);

                return passesUnitFilter && passesDurationFilter && passesAlarmFilter && passesContainsAlarmFilter;
            });

            const uniqueUnits = React.useMemo(() => {
                if (!sessions || sessions.length === 0) return [];
                const units = new Set(sessions.map(s => s.unit));
                return Array.from(units).sort();
            }, [sessions]);

            const getChatSuggestions = () => {
                const suggestions = [];

                if (sessions.length > 0) {
                    const alarmCounts = {};
                    sessions.forEach(s => {
                        s.events.filter(e => e.isAlarm).forEach(e => {
                            alarmCounts[e.tag] = (alarmCounts[e.tag] || 0) + 1;
                        });
                    });
                    const topAlarm = Object.entries(alarmCounts).sort((a, b) => b[1] - a[1])[0];

                    if (topAlarm) {
                        suggestions.push(`What causes ${topAlarm[0]} alarms?`);
                    }

                    suggestions.push('Show me recent alarm patterns');
                    suggestions.push('Generate a monthly compliance report');  // <--- NEW FEATURE
                    suggestions.push('Find sessions with alarm floods');
                }

                return suggestions;
            };


            // --- VISUALIZATION EFFECTS ---
            React.useEffect(() => {
                const destroyChart = (instanceRef) => {
                    if (instanceRef.current) {
                        instanceRef.current.destroy();
                        instanceRef.current = null;
                    }
                };

                destroyChart(hourlyChartInstanceRef);
                destroyChart(startingEventChartInstanceRef);
                destroyChart(alarmFrequencyChartInstanceRef);
                destroyChart(nuisanceScoreChartInstanceRef);
                destroyChart(unitStatsChartInstanceRef);
                if (networkInstanceRef.current) {
                    networkInstanceRef.current.destroy();
                    networkInstanceRef.current = null;
                }

                if (filteredProcessGraph && networkRef.current && activeTab === 'process') {
                    const options = {
                        layout: {
                            hierarchical: false,
                            improvedLayout: true,
                            randomSeed: 2
                        },
                        physics: {
                            enabled: true,
                            solver: 'repulsion',
                            repulsion: {
                                nodeDistance: 250,
                                centralGravity: 0.2,
                                springLength: 250,
                                springConstant: 0.05,
                                damping: 0.09
                            },
                            stabilization: {
                                enabled: true,
                                iterations: 2500,
                                updateInterval: 100,
                                onlyDynamicEdges: false,
                                fit: true
                            }
                        },
                        nodes: {
                            shape: 'box',
                            font: { size: 14, face: 'Arial' },
                            borderWidth: 2,
                            margin: 12,
                            widthConstraint: { minimum: 120, maximum: 180 },
                            shadow: { enabled: true, color: 'rgba(0,0,0,0.2)', size: 5, x: 2, y: 2 }
                        },
                        edges: {
                            arrows: { to: { enabled: true, scaleFactor: 1, type: 'arrow' } },
                            smooth: false,
                            font: {
                                size: 12,
                                align: 'horizontal',
                                background: 'white',
                                strokeWidth: 0,
                                vadjust: -2
                            },
                            color: { inherit: false }
                        },
                        interaction: {
                            hover: true,
                            tooltipDelay: 100,
                            zoomView: true,
                            dragView: true,
                            dragNodes: true,
                            selectConnectedEdges: false
                        }
                    };

                    networkInstanceRef.current = new vis.Network(networkRef.current, filteredProcessGraph, options);

                    networkInstanceRef.current.on("click", function (params) {
                        if (params.edges.length > 0 && params.nodes.length === 0) {
                            const edgeId = params.edges[0];
                            const edges = networkInstanceRef.current.body.data.edges;
                            const nodes = networkInstanceRef.current.body.data.nodes;

                            const edge = edges.get(edgeId);
                            if (edge) {
                                const fromNode = nodes.get(edge.from);
                                const toNode = nodes.get(edge.to);

                                const fromLabel = fromNode ? (fromNode.label || '').replace(/\n/g, ' ') : edge.from;
                                const toLabel = toNode ? (toNode.label || '').replace(/\n/g, ' ') : edge.to;

                                alert(`Flow Details:\n\nFrom: ${fromLabel}\nTo: ${toLabel}\n\nCount: ${edge.label || 'N/A'}\nDependency Strength: ${edge.title || 'N/A'}`);
                            }
                        }
                    });

                    networkInstanceRef.current.on("dragEnd", function (params) {
                        if (params.nodes.length > 0) {
                            const nodeId = params.nodes[0];
                            networkInstanceRef.current.body.data.nodes.update({
                                id: nodeId,
                                fixed: { x: true, y: true }
                            });
                        }
                    });

                    networkInstanceRef.current.once('stabilized', () => {
                        networkInstanceRef.current.fit({
                            animation: {
                                duration: 500,
                                easingFunction: 'easeInOutQuad'
                            }
                        });
                    });
                }

                if (dfgData && dfgData.dfgVisual && pm4jsRef.current && activeTab === 'process') {
                    pm4jsRef.current.innerHTML = dfgData.dfgVisual;
                }

                if (statistics && activeTab === 'statistics' && hourlyChartRef.current) {
                    hourlyChartInstanceRef.current = new Chart(hourlyChartRef.current.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                            datasets: [{ label: 'Events per Hour', data: statistics.hourlyDistribution, borderColor: '#667eea', tension: 0.4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                if (statistics && activeTab === 'overview' && startingEventChartRef.current) {
                    startingEventChartInstanceRef.current = new Chart(startingEventChartRef.current.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: statistics.topStartingEvents.map(item => item[0]),
                            datasets: [{
                                label: 'Session Start Events',
                                data: statistics.topStartingEvents.map(item => item[1]),
                                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                hoverBackgroundColor: 'rgba(102, 126, 234, 0.8)'
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `Count: ${context.parsed.x}`;
                                        }
                                    }
                                }
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const startingEventLabel = statistics.topStartingEvents[index][0];
                                    let uniqueId = startingEventLabel;

                                    // FIX: Robust handling of emojis vs characters
                                    if (startingEventLabel.includes('âš ï¸')) {
                                        // Remove emoji and trim potential leading space
                                        uniqueId = `[A] ${startingEventLabel.replace('âš ï¸', '').trim()}`;
                                    } else if (startingEventLabel.includes('âœ“')) {
                                        uniqueId = `[C] ${startingEventLabel.replace('âœ“', '').trim()}`;
                                    } else {
                                        uniqueId = `[E] ${startingEventLabel}`;
                                    }

                                    console.log('Navigating to process mining with starting event:', uniqueId);

                                    setProcessFilters(prev => ({
                                        ...prev,
                                        startingAlarm: uniqueId,
                                        containsAlarm: '',
                                        selectedSession: null,
                                        timeRange: { start: null, end: null }
                                    }));
                                    setNeedsProcessUpdate(true);
                                    setActiveTab('process');
                                }
                            }
                        }
                    });
                }
                if (validSessions.length > 0 && activeTab === 'statistics' && alarmFrequencyChartRef.current) {
                    const sampledSessions = validSessions.filter((_, idx) => idx % Math.ceil(validSessions.length / 100) === 0);
                    alarmFrequencyChartInstanceRef.current = new Chart(alarmFrequencyChartRef.current.getContext('2d'), {
                        type: 'scatter',
                        data: {
                            datasets: [{
                                label: 'Alarm Frequency',
                                data: sampledSessions.map((s, idx) => ({
                                    x: idx,
                                    y: s.alarmFrequency,
                                    sessionId: s.id
                                })),
                                backgroundColor: sampledSessions.map(s => s.alarmFrequency > 10 ? 'rgba(220, 38, 38, 0.6)' : 'rgba(34, 197, 94, 0.6)')
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Session Index'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Alarms per 10 minutes'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const session = sampledSessions[context.dataIndex];
                                            return [
                                                `Session ID: ${session.id}`,
                                                `${unitColumnLabel}: ${session.unit}`,
                                                `Alarm Frequency: ${context.parsed.y.toFixed(2)}`,
                                                `Duration: ${moment.duration(session.duration).humanize()}`
                                            ];
                                        }
                                    }
                                }
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const dataIndex = elements[0].index;
                                    const session = sampledSessions[dataIndex];
                                    console.log('Clicked session:', session.id);
                                    if (session) {
                                        showSessionInProcessMining(session);
                                    }
                                }
                            }
                        }
                    });
                }
                if (nuisanceAlarms.length > 0 && activeTab === 'rationalization' && nuisanceScoreChartRef.current) {
                    const scoreRanges = { '0-40': 0, '41-70': 0, '71-100': 0 };
                    nuisanceAlarms.forEach(a => {
                        if (a.nuisanceScore <= 40) scoreRanges['0-40']++;
                        else if (a.nuisanceScore <= 70) scoreRanges['41-70']++;
                        else scoreRanges['71-100']++;
                    });
                    nuisanceScoreChartInstanceRef.current = new Chart(nuisanceScoreChartRef.current.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(scoreRanges),
                            datasets: [{
                                data: Object.values(scoreRanges),
                                backgroundColor: ['#d1fae5', '#fef3c7', '#fee2e2']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                if (unitStats.length > 0 && activeTab === 'overview' && unitStatsChartRef.current) {
                    const topUnits = unitStats.slice(0, 10);
                    unitStatsChartInstanceRef.current = new Chart(unitStatsChartRef.current.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: topUnits.map(u => u.unit),
                            datasets: [
                                {
                                    label: 'Sessions',
                                    data: topUnits.map(u => u.sessionCount),
                                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Avg Alarm Frequency',
                                    data: topUnits.map(u => u.avgAlarmFrequency),
                                    backgroundColor: 'rgba(220, 38, 38, 0.6)',
                                    yAxisID: 'y1',
                                    type: 'line'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Session Count'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Avg Alarm Frequency'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        afterLabel: function (context) {
                                            const unit = topUnits[context.dataIndex];
                                            return [
                                                `Total Alarms: ${unit.totalAlarms}`,
                                                `Total Actions: ${unit.totalActions}`,
                                                `Avg Duration: ${moment.duration(unit.avgSessionDuration).humanize()}`
                                            ];
                                        }
                                    }
                                }
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const unit = topUnits[index].unit;

                                    setProcessFilters(prev => ({
                                        ...prev,
                                        unit: unit,
                                        selectedSession: null,
                                        startingAlarm: '',
                                        containsAlarm: '',
                                        timeRange: { start: null, end: null }
                                    }));
                                    setNeedsProcessUpdate(true);
                                    setActiveTab('process');
                                }
                            }
                        }
                    });
                }

            }, [activeTab, statistics, validSessions, filteredProcessGraph, dfgData, nuisanceAlarms, unitStats, unitColumnLabel]);

            // --- JSX FOR RENDERING ---
            // Helper function to toggle theme
            const toggleTheme = () => {
                const newTheme = appTheme === 'light' ? 'dark' : 'light';
                setAppTheme(newTheme);
                localStorage.setItem('appTheme', newTheme);
                document.documentElement.setAttribute('data-theme', newTheme);
            };

            // Apply theme on initial render
            React.useEffect(() => {
                document.documentElement.setAttribute('data-theme', appTheme);
            }, []);

            // Helper to check if D&R model is a reasoning model (GPT-5, o1, o3, o4)
            const isReasoningModel = () => {
                const name = (chatbotSettings.drDeploymentName || chatbotSettings.deploymentName || '').toLowerCase();
                return name.includes('gpt-5') || name.includes('o1') || name.includes('o3') || name.includes('o4');
            };

            return (
                <div className="min-h-screen" style={{ backgroundColor: 'var(--bg-primary)', color: 'var(--text-primary)' }}>
                    {/* Global Help Modal */}
                    <HelpModal
                        isOpen={helpModalOpen}
                        onClose={() => setHelpModalOpen(false)}
                        title={helpModalContent.title}
                        content={helpModalContent.body}
                    />



                    {/* Leaner Header */}
                    <header className="gradient-bg text-white shadow-lg">
                        <div className="container mx-auto px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <img src="octave-logo.svg" alt="Octave" className="h-7 brightness-0 invert" style={{ width: 'auto' }} />
                                    <h1 className="text-xl font-bold">Alarm Analyzer Pro</h1>
                                    <span className="text-purple-200 text-sm hidden sm:inline">AI-Enhanced Process Mining</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    {/* Theme Toggle */}
                                    <button
                                        onClick={toggleTheme}
                                        className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                                        title={appTheme === 'light' ? 'Switch to Dark Mode' : 'Switch to Light Mode'}
                                    >
                                        <i className={`fas ${appTheme === 'light' ? 'fa-moon' : 'fa-sun'} text-lg`}></i>
                                    </button>
                                    {/* Settings */}
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className="p-2 rounded-lg hover:bg-white/10 transition-colors"
                                        title="Settings"
                                    >
                                        <i className="fas fa-cog text-lg"></i>
                                    </button>
                                    {/* Hidden file input for CSV upload */}
                                    <input ref={fileInputRef} type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                    {data && (
                                        <button onClick={handleTrainModel} disabled={modelStatus === 'training'} className="bg-purple-700 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-purple-800 transition-colors disabled:opacity-50 text-sm">
                                            <i className="fas fa-brain mr-1"></i>{modelStatus === 'training' ? 'Training...' : 'Train'}
                                        </button>
                                    )}
                                    {model && modelStatus === 'trained' && (
                                        <button onClick={handleDeleteModel} className="bg-red-600 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-red-700 transition-colors text-sm" title="Delete saved model">
                                            <i className="fas fa-trash"></i>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="container mx-auto px-4 py-8">
                        {isProcessing && !showColumnMapping && (
                            <div className="flex items-center justify-center py-12">
                                <div className="loading-spinner"></div>
                                <span className="ml-4 text-gray-600">Processing data...</span>
                            </div>
                        )}

                        {/* Column Mapping Modal */}
                        {showColumnMapping && columnAnalysis && (
                            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                                <div className="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
                                    <div className="mb-4">
                                        <h2 className="text-2xl font-bold text-gray-900">Configure Column Mappings</h2>
                                        <p className="text-sm text-gray-600 mt-2">
                                            Please review and confirm the column mappings for: <span className="font-medium">{uploadedFileName}</span>
                                        </p>
                                    </div>

                                    <div className="max-h-[70vh] overflow-y-auto px-1">
                                        <div dangerouslySetInnerHTML={{ __html: window.dataService.createColumnMappingUI(columnAnalysis) }} />
                                    </div>

                                    <div className="flex justify-end gap-3 mt-6 pt-4 border-t">
                                        <button
                                            onClick={handleCancelMapping}
                                            className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleConfirmMapping}
                                            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                                        >
                                            <i className="fas fa-check mr-2"></i>
                                            Confirm & Process
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {modelStatus === 'training' && (
                            <div className="card mb-6 border-l-4 border-purple-500">
                                <h3 className="text-lg font-semibold text-purple-700 mb-2">Training Model...</h3>
                                <div className="flex items-center mb-2">
                                    <span className="text-sm font-medium text-gray-700 w-28">Epoch Progress:</span>
                                    <span className="text-sm font-semibold text-purple-700">{trainingProgress.epoch} / {trainingProgress.totalEpochs}</span>
                                </div>
                                <div className="training-progress mb-4">
                                    <div className="training-progress-bar" style={{ width: `${(trainingProgress.epoch / trainingProgress.totalEpochs) * 100}%` }}></div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div className="text-center p-2 bg-gray-50 rounded">
                                        <p className="font-semibold text-gray-600">Loss</p>
                                        <p className="font-mono text-lg">{trainingProgress.loss ? trainingProgress.loss.toFixed(4) : 'N/A'}</p>
                                    </div>
                                    <div className="text-center p-2 bg-gray-50 rounded">
                                        <p className="font-semibold text-gray-600">Accuracy</p>
                                        <p className="font-mono text-lg">{trainingProgress.accuracy ? (trainingProgress.accuracy * 100).toFixed(1) + '%' : 'N/A'}</p>
                                    </div>
                                    <div className="text-center p-2 bg-gray-50 rounded">
                                        <p className="font-semibold text-gray-600">Validation Loss</p>
                                        <p className="font-mono text-lg">{trainingProgress.valLoss ? trainingProgress.valLoss.toFixed(4) : 'N/A'}</p>
                                    </div>
                                    <div className="text-center p-2 bg-gray-50 rounded">
                                        <p className="font-semibold text-gray-600">Validation Accuracy</p>
                                        <p className="font-mono text-lg">{trainingProgress.valAccuracy ? (trainingProgress.valAccuracy * 100).toFixed(1) + '%' : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Landing Page - Workflow Selection */}
                        {!isProcessing && appMode === 'landing' && (
                            <div className="text-center py-16">
                                <i className="fas fa-chart-line text-6xl text-purple-500 mb-6"></i>
                                <h2 className="text-3xl font-bold mb-3" style={{ color: 'var(--text-primary)' }}>
                                    Welcome to Alarm Analyzer Pro
                                </h2>
                                <p className="text-lg mb-10" style={{ color: 'var(--text-secondary)' }}>
                                    Choose your workflow to get started
                                </p>

                                <div className="flex flex-col sm:flex-row gap-6 justify-center max-w-2xl mx-auto">
                                    {/* Alarm Event Analysis */}
                                    <div
                                        onClick={() => {
                                            setData(null);
                                            setStatistics(null);
                                            setAppMode('analysis');
                                        }}
                                        className="flex-1 p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-xl border-2 border-purple-200 dark:border-purple-700 hover:border-purple-500"
                                        style={{ backgroundColor: 'var(--bg-card)' }}
                                    >
                                        <i className="fas fa-project-diagram text-5xl text-purple-500 mb-4"></i>
                                        <h3 className="text-xl font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                            Alarm Event Analysis
                                        </h3>
                                        <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                            Process mining, session analysis, pattern detection, and AI-assisted insights from alarm event data
                                        </p>
                                        <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                            <span className="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded">Process Mining</span>
                                            <span className="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded">Statistics</span>
                                            <span className="text-xs px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded">AI Chat</span>
                                        </div>
                                    </div>

                                    {/* AI Rationalization (D&R) */}
                                    <div
                                        onClick={() => { setAppMode('rationalization'); setActiveTab('ai-rationalization'); }}
                                        className="flex-1 p-8 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-xl border-2 border-blue-200 dark:border-blue-700 hover:border-blue-500"
                                        style={{ backgroundColor: 'var(--bg-card)' }}
                                    >
                                        <i className="fas fa-robot text-5xl text-blue-500 mb-4"></i>
                                        <h3 className="text-xl font-bold mb-2" style={{ color: 'var(--text-primary)' }}>
                                            AI Rationalization (D&R)
                                        </h3>
                                        <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                                            AI-powered alarm rationalization with philosophy extraction and automated D&R drafting
                                        </p>
                                        <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                            <span className="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded">AI Drafting</span>
                                            <span className="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded">Compliance</span>
                                            <span className="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded">Export</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* No Data Prompt - Only for Analysis mode */}
                        {!isProcessing && appMode === 'analysis' && !data && (
                            <div className="text-center py-12">
                                <button
                                    onClick={() => setAppMode('landing')}
                                    className="mb-6 text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-medium"
                                >
                                    <i className="fas fa-arrow-left mr-2"></i>Back to Home
                                </button>
                                <div>
                                    <i className="fas fa-file-csv text-6xl text-gray-400 mb-4"></i>
                                    <h2 className="text-2xl font-semibold mb-2" style={{ color: 'var(--text-primary)' }}>No Data Loaded</h2>
                                    <p className="mb-6" style={{ color: 'var(--text-secondary)' }}>Upload a CSV file to begin analysis.</p>
                                    <button onClick={() => fileInputRef.current?.click()} className="bg-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                        <i className="fas fa-upload mr-2"></i>Select CSV File
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Rationalization Mode - Wizard always mounted, hidden when inactive to preserve state */}
                        <div style={{ display: (!isProcessing && appMode === 'rationalization') ? 'block' : 'none' }}>
                            {/* Back to Home */}
                            <div className="mb-4">
                                <button
                                    onClick={() => { setAppMode('landing'); setActiveTab('overview'); }}
                                    className="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-medium"
                                >
                                    <i className="fas fa-arrow-left mr-2"></i>Back to Home
                                </button>
                            </div>
                            <AIRationalizationWizard isActive={appMode === 'rationalization'} />
                        </div>

                        {data && statistics && appMode === 'analysis' && (
                            <>
                                {/* Back to Home */}
                                <div className="mb-4">
                                    <button
                                        onClick={() => { setAppMode('landing'); }}
                                        className="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-medium"
                                    >
                                        <i className="fas fa-arrow-left mr-2"></i>Back to Home
                                    </button>
                                </div>

                                {/* Metric Cards */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    <div className="metric-card">
                                        <div className="flex items-center justify-between">
                                            <div><p className="text-gray-600 text-sm">Total Events</p><p className="text-2xl font-bold text-gray-800">{statistics.totalEvents.toLocaleString()}</p></div>
                                            <i className="fas fa-chart-line text-3xl text-purple-500"></i>
                                        </div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="flex items-center justify-between">
                                            <div><p className="text-gray-600 text-sm">Total Alarms</p><p className="text-2xl font-bold text-red-600">{statistics.totalAlarms.toLocaleString()}</p></div>
                                            <i className="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                                        </div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="flex items-center justify-between">
                                            <div><p className="text-gray-600 text-sm">Operator Actions</p><p className="text-2xl font-bold text-blue-600">{statistics.totalActions.toLocaleString()}</p></div>
                                            <i className="fas fa-user-cog text-3xl text-blue-500"></i>
                                        </div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-gray-600 text-sm">Valid Sessions</p>
                                                <p className="text-2xl font-bold text-green-600">{validSessions.length.toLocaleString()}</p>
                                                <p className="text-xs text-gray-500">(â‰¥4 events)</p>
                                            </div>
                                            <i className="fas fa-layer-group text-3xl text-green-500"></i>
                                        </div>
                                    </div>
                                </div>

                                {/* Tabs */}
                                <div className="flex space-x-2 mb-6 border-b overflow-x-auto">
                                    <button onClick={() => setActiveTab('overview')} className={`tab-button ${activeTab === 'overview' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-home mr-2"></i>Overview</button>
                                    <button onClick={() => setActiveTab('statistics')} className={`tab-button ${activeTab === 'statistics' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-chart-bar mr-2"></i>Statistics</button>
                                    <button onClick={() => setActiveTab('process')} className={`tab-button ${activeTab === 'process' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-project-diagram mr-2"></i>Process Mining</button>
                                    <button onClick={() => setActiveTab('variants')} className={`tab-button ${activeTab === 'variants' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-code-branch mr-2"></i>Process Variants</button>
                                    <button onClick={() => setActiveTab('sessions')} className={`tab-button ${activeTab === 'sessions' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-stream mr-2"></i>Sessions</button>
                                    <button onClick={() => setActiveTab('prediction')} className={`tab-button ${activeTab === 'prediction' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}><i className="fas fa-brain mr-2"></i>Prediction</button>
                                    <button
                                        onClick={() => setActiveTab('assistant')}
                                        className={`tab-button ${activeTab === 'assistant' ? 'active' : 'text-gray-600 hover:text-gray-800'}`}
                                    >
                                        <i className="fas fa-comments mr-2"></i>AI Assistant
                                        {/* Backend handles configuration */}
                                    </button>
                                </div>



                                {activeTab === 'overview' && (
                                    <div>
                                        <div className="tab-header">
                                            <h2 className="text-2xl font-bold">System Overview</h2>
                                        </div>
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">{unitColumnLabel} Performance Overview</h3>
                                                <p className="text-xs text-gray-500 mb-2">Click on a {unitColumnLabel.toLowerCase()} to filter Process Mining</p>
                                                <div className="h-80"><canvas ref={unitStatsChartRef}></canvas></div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Top Starting Events per Session</h3>
                                                <p className="text-xs text-gray-500 mb-2">Click on a bar to filter Process Mining by that starting event</p>
                                                <div className="h-80"><canvas ref={startingEventChartRef}></canvas></div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Top Alarm â†’ Action Patterns</h3>
                                                <div className="space-y-2">
                                                    {statistics.topPatterns.map(([pattern, count], idx) => (
                                                        <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                                                            <span className="text-sm font-medium">{pattern}</span>
                                                            <span className="text-sm text-gray-600">{count} occurrences</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">{unitColumnLabel} Distribution</h3>
                                                <div className="space-y-3">
                                                    <div className="text-sm text-gray-600 mb-2">
                                                        Total {unitColumnLabelPlural}: <span className="font-bold">{uniqueUnits.length}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600 mb-2">
                                                        Sessions span single {unitColumnLabel.toLowerCase()}s only (no cross-{unitColumnLabel.toLowerCase()} sessions)
                                                    </div>
                                                    <div className="max-h-40 overflow-y-auto">
                                                        {unitStats.slice(0, 10).map((unit, idx) => (
                                                            <div key={idx} className="flex items-center justify-between py-1">
                                                                <span className="text-sm font-medium">{unit.unit}</span>
                                                                <div className="text-sm text-gray-600">
                                                                    {unit.sessionCount} sessions | {unit.totalEvents} events
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'statistics' && (
                                    <div>
                                        <div className="tab-header flex justify-between items-start">
                                            <div>
                                                <h2 className="text-2xl font-bold">Statistical Analysis & KPIs</h2>
                                            </div>
                                            <button onClick={() => openHelp('kpi')} className="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center">
                                                <i className="fas fa-info-circle mr-1"></i> Guide to KPIs
                                            </button>
                                        </div>

                                        {/* New Insight Card for Statistics */}
                                        {showStatsInsight && (
                                            <InsightCard
                                                title="ISA 18.2 Performance Standards"
                                                icon="fa-chart-pie"
                                                onClose={() => setShowStatsInsight(false)}
                                                onMoreInfo={() => openHelp('kpi')}
                                            >
                                                <p className="mb-2">
                                                    Standard performance targets for industrial alarm systems:
                                                </p>
                                                <ul className="list-disc pl-5 space-y-1 text-xs mb-2">
                                                    <li><strong>Alarm Rate:</strong> manageable â‰¤ 1 alarm per 10 minutes.</li>
                                                    <li><strong>Flood Rate:</strong> Target &lt; 1% of time in flood condition (&gt;10 alarms/10 min).</li>
                                                    <li><strong>Chattering:</strong> Target &lt; 5% of alarms should be chattering (repeating &gt;3 times/min).</li>
                                                </ul>
                                            </InsightCard>
                                        )}

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="card lg:col-span-2">
                                                <h3 className="text-lg font-semibold mb-4">Industry Standard KPIs (ISA 18.2)</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    <div className="p-4 bg-gray-50 rounded-lg text-center">
                                                        <p className="text-gray-600 text-sm">Avg. Alarm Rate</p>
                                                        <p className={`text-3xl font-bold ${statistics.avgAlarmRate > 2 ? 'text-red-600' : statistics.avgAlarmRate > 1 ? 'text-yellow-600' : 'text-green-600'}`}>{statistics.avgAlarmRate.toFixed(1)}</p>
                                                        <p className="text-xs text-gray-500">Alarms / 10 Min (manageable â‰¤ 1)</p>
                                                    </div>
                                                    <div className="p-4 bg-gray-50 rounded-lg text-center">
                                                        <p className="text-gray-600 text-sm">% Time in Alarm Flood</p>
                                                        <p className={`text-3xl font-bold ${statistics.percentTimeInFlood > 1 ? 'text-red-600' : 'text-green-600'}`}>{statistics.percentTimeInFlood.toFixed(1)}%</p>
                                                        <p className="text-xs text-gray-500">Target &lt; 1%</p>
                                                    </div>
                                                    <div className="p-4 bg-gray-50 rounded-lg">
                                                        <p className="text-gray-600 text-sm text-center mb-2">Top 5 Chattering Alarms</p>
                                                        <div className="space-y-1">
                                                            {statistics.topChatteringAlarms.length > 0 ? statistics.topChatteringAlarms.map(([tag, count], idx) => (
                                                                <div key={idx} className="flex justify-between text-sm">
                                                                    <span className="font-medium">{tag}</span>
                                                                    <span className="text-gray-500">{count} repeats</span>
                                                                </div>
                                                            )) : <p className="text-sm text-gray-500 text-center">No significant chattering detected.</p>}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Hourly Event Distribution</h3>
                                                <div style={{ height: '300px' }}><canvas ref={hourlyChartRef}></canvas></div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Session Alarm Frequency Analysis</h3>
                                                <div className="legend-box mb-2">
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        <i className="fas fa-info-circle"></i> Click on any point to view session in Process Mining
                                                    </div>
                                                </div>
                                                <div style={{ height: '300px' }}><canvas ref={alarmFrequencyChartRef}></canvas></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'process' && (
                                    <div>
                                        <div className="tab-header flex justify-between items-start">
                                            <div>
                                                <h2 className="text-2xl font-bold">Process Mining Visualization</h2>
                                            </div>
                                            <button onClick={() => openHelp('processMining')} className="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center">
                                                <i className="fas fa-info-circle mr-1"></i> Guide to Process Mining
                                            </button>
                                        </div>

                                        {/* New Insight Card for Process Mining */}
                                        {showProcessInsight && (
                                            <InsightCard
                                                title="Understanding Process Mining"
                                                icon="fa-project-diagram"
                                                onClose={() => setShowProcessInsight(false)}
                                                onMoreInfo={() => openHelp('processMining')}
                                            >
                                                <p className="mb-2">
                                                    This module uses a <strong>Heuristic Miner</strong> algorithm to discover causal patterns in your data:
                                                </p>
                                                <ul className="list-disc pl-5 space-y-1 text-xs mb-2">
                                                    <li><strong>Dependency Matrix:</strong> Calculates how often event B follows A (minus reverse) to find true causality.</li>
                                                    <li><strong>Heuristic Net:</strong> The graph below shows Activities (Nodes) and Causal Dependencies (Edges).</li>
                                                    <li><strong>Filtering:</strong> Use the sliders to filter out weak dependencies (noise) and focus on the main process path.</li>
                                                </ul>
                                            </InsightCard>
                                        )}

                                        <div className="filter-section">
                                            <h4 className="font-semibold mb-3">Process Mining Filters</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">{unitColumnLabel}</label>
                                                    <select
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={processFilters.unit}
                                                        onChange={(e) => setProcessFilters(prev => ({ ...prev, unit: e.target.value }))}
                                                    >
                                                        <option value="all">All {unitColumnLabelPlural}</option>
                                                        {uniqueUnits.map(unit => (
                                                            <option key={unit} value={unit}>{unit}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Time Range Start</label>
                                                    <input
                                                        type="datetime-local"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={processFilters.timeRange.start ? moment(processFilters.timeRange.start).format('YYYY-MM-DDTHH:mm') : ''}
                                                        onChange={(e) => setProcessFilters(prev => ({
                                                            ...prev,
                                                            timeRange: { ...prev.timeRange, start: e.target.value ? new Date(e.target.value).getTime() : null }
                                                        }))}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Time Range End</label>
                                                    <input
                                                        type="datetime-local"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={processFilters.timeRange.end ? moment(processFilters.timeRange.end).format('YYYY-MM-DDTHH:mm') : ''}
                                                        onChange={(e) => setProcessFilters(prev => ({
                                                            ...prev,
                                                            timeRange: { ...prev.timeRange, end: e.target.value ? new Date(e.target.value).getTime() : null }
                                                        }))}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Starting Event</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        placeholder="e.g., âš ï¸ LC5201"
                                                        value={processFilters.startingAlarm}
                                                        onChange={(e) => setProcessFilters(prev => ({ ...prev, startingAlarm: e.target.value }))}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Contains Alarm Tag</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        placeholder="e.g., HS-901A (raw tag)"
                                                        value={processFilters.containsAlarm}
                                                        onChange={(e) => setProcessFilters(prev => ({ ...prev, containsAlarm: e.target.value }))}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Session ID</label>
                                                    <input
                                                        type="number"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        placeholder="Session ID"
                                                        value={processFilters.selectedSession ?? ''}
                                                        onChange={(e) => setProcessFilters(prev => ({ ...prev, selectedSession: e.target.value ? parseInt(e.target.value) : null }))}
                                                    />
                                                </div>
                                            </div>

                                            {/* Heuristic Mining Parameters */}
                                            <h4 className="font-semibold mb-3 mt-6">Heuristic Mining Parameters</h4>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Dependency Threshold
                                                        <span className="text-xs text-gray-500 ml-1">({heuristicFilters.dependencyThreshold})</span>
                                                    </label>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="1"
                                                        step="0.1"
                                                        className="w-full"
                                                        value={heuristicFilters.dependencyThreshold}
                                                        onChange={(e) => setHeuristicFilters(prev => ({
                                                            ...prev,
                                                            dependencyThreshold: parseFloat(e.target.value)
                                                        }))}
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Frequency Threshold
                                                        <span className="text-xs text-gray-500 ml-1">({(heuristicFilters.frequencyThreshold * 100).toFixed(0)}%)</span>
                                                    </label>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="0.2"
                                                        step="0.01"
                                                        className="w-full"
                                                        value={heuristicFilters.frequencyThreshold}
                                                        onChange={(e) => setHeuristicFilters(prev => ({
                                                            ...prev,
                                                            frequencyThreshold: parseFloat(e.target.value)
                                                        }))}
                                                    />
                                                </div>
                                                <div className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id="showLoops"
                                                        className="mr-2"
                                                        checked={heuristicFilters.showLoops}
                                                        onChange={(e) => setHeuristicFilters(prev => ({
                                                            ...prev,
                                                            showLoops: e.target.checked
                                                        }))}
                                                    />
                                                    <label htmlFor="showLoops" className="text-sm font-medium text-gray-700">
                                                        Show Loops
                                                    </label>
                                                </div>
                                                <div className="flex items-center">
                                                    <input
                                                        type="checkbox"
                                                        id="showParallel"
                                                        className="mr-2"
                                                        checked={heuristicFilters.showParallel}
                                                        onChange={(e) => setHeuristicFilters(prev => ({
                                                            ...prev,
                                                            showParallel: e.target.checked
                                                        }))}
                                                    />
                                                    <label htmlFor="showParallel" className="text-sm font-medium text-gray-700">
                                                        Show Parallel Activities
                                                    </label>
                                                </div>
                                            </div>

                                            <div className="mt-4 flex justify-between">
                                                <div className="text-xs text-gray-500">
                                                    <i className="fas fa-info-circle mr-1"></i>
                                                    Higher dependency threshold shows only stronger causal relations
                                                </div>
                                                <div className="space-x-2">
                                                    <button onClick={handleResetFilters} className="bg-gray-400 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-500">Reset</button>
                                                    <button onClick={applyProcessFilters} className="bg-purple-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-purple-700">Apply Filters</button>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Process Statistics */}
                                        {processStats && (
                                            <div className="mb-4">
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                                    <div className="bg-blue-50 rounded-lg p-4 text-center">
                                                        <p className="text-sm text-blue-600">Total Activities</p>
                                                        <p className="text-2xl font-bold text-blue-800">{processStats.totalActivities}</p>
                                                    </div>
                                                    <div className="bg-green-50 rounded-lg p-4 text-center">
                                                        <p className="text-sm text-green-600">Causal Relations</p>
                                                        <p className="text-2xl font-bold text-green-800">{processStats.totalEdges}</p>
                                                    </div>
                                                    <div className="bg-purple-50 rounded-lg p-4 text-center">
                                                        <p className="text-sm text-purple-600">Parallel Gateways</p>
                                                        <p className="text-2xl font-bold text-purple-800">{processStats.parallelGateways || 0}</p>
                                                    </div>
                                                    <div className="bg-red-50 rounded-lg p-4 text-center">
                                                        <p className="text-sm text-red-600">Loop Patterns</p>
                                                        <p className="text-2xl font-bold text-red-800">{processStats.loops || 0}</p>
                                                    </div>
                                                </div>
                                                {processStats.strongestDependency && (
                                                    <div className="bg-yellow-50 rounded-lg p-3">
                                                        <p className="text-sm text-yellow-800">
                                                            <i className="fas fa-link mr-2"></i>
                                                            <strong>Strongest Dependency:</strong> {processStats.strongestDependency.from.replace(/\[A\]|\[C\]|\[E\]/g, '')} â†’ {processStats.strongestDependency.to.replace(/\[A\]|\[C\]|\[E\]/g, '')}
                                                            <span className="ml-2">(dependency: {processStats.strongestDependency.dependency.toFixed(2)})</span>
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
                                            <div className="card" ref={networkContainerRef}>
                                                <div className="flex justify-between items-center mb-4">
                                                    <div>
                                                        <h3 className="text-lg font-semibold">Process Flow Network</h3>
                                                        <p className="text-sm text-gray-600">Hierarchical view showing alarm and action sequences with frequencies</p>
                                                    </div>
                                                    <button
                                                        onClick={toggleFullscreen}
                                                        className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700"
                                                        title="Toggle fullscreen"
                                                    >
                                                        <i className="fas fa-expand"></i>
                                                    </button>
                                                </div>
                                                <div ref={networkRef} className="process-network" style={{ height: '600px', border: '1px solid #e5e7eb', borderRadius: '0.5rem' }}></div>
                                                <div className="mt-4 flex flex-wrap gap-4 text-sm">
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-4 rounded-full bg-green-400 border-2 border-green-600 mr-2"></div>
                                                        <span>Start Event</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-4 rounded-full bg-pink-300 border-2 border-red-500 mr-2"></div>
                                                        <span>End Event</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-4 bg-orange-200 border-2 border-orange-500 mr-2"></div>
                                                        <span>Alarm</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-4 bg-blue-200 border-2 border-blue-500 mr-2"></div>
                                                        <span>Action</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-4 bg-purple-200 border-2 border-purple-500 mr-2 transform rotate-45"></div>
                                                        <span>AND Gateway</span>
                                                    </div>
                                                    <div className="flex items-center">
                                                        <div className="w-4 h-1 bg-red-500 mr-2" style={{ borderTop: '2px dashed #DC143C' }}></div>
                                                        <span>Loop</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Process Intelligence & Pattern Analysis</h3>
                                                <p className="text-sm text-gray-600 mb-4">AI-discovered insights, patterns, and dependencies in your alarm data</p>
                                                <div ref={pm4jsRef} id="pm4js-container" className="overflow-y-auto" style={{ maxHeight: '600px' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'variants' && (
                                    <div className="card">
                                        <div className="mb-4">
                                            <h2 className="text-2xl font-bold">Process Variants Discovery</h2>
                                        </div>
                                        <p className="text-sm text-gray-600 mb-4">Top {processVariants.length} most frequent process patterns (discovered using heuristic mining)</p>
                                        {processVariants.slice(variantPage * ITEMS_PER_PAGE, (variantPage + 1) * ITEMS_PER_PAGE).map((variant, idx) => (
                                            <div key={idx} className="process-variant" onClick={() => showVariantInProcessMining(variant)}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <h4 className="font-medium">Variant #{variantPage * ITEMS_PER_PAGE + idx + 1}</h4>
                                                    <div className="text-right">
                                                        <span className="text-sm font-semibold text-purple-600">{variant.count} sessions</span>
                                                        {variant.conformance !== undefined && (
                                                            <div className="text-xs mt-1">
                                                                <span className={`${variant.conformance > 0.8 ? 'text-green-600' : variant.conformance > 0.5 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                                    Conformance: {(variant.conformance * 100).toFixed(0)}%
                                                                </span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="text-sm text-gray-700 mb-1" dangerouslySetInnerHTML={{ __html: variant.variant.replace(/âš ï¸/g, 'âš ï¸<span class="text-orange-700">').replace(/âœ“/g, 'âœ“<span class="text-blue-700">').replace(/(\sâ†’\s|\*)/g, '</span>$1') + '</span>' }}>
                                                </div>
                                                <div className="grid grid-cols-3 gap-2 text-xs mt-2">
                                                    <div><span className="text-gray-500">Avg Duration:</span> {moment.duration(variant.avgDuration).humanize()}</div>
                                                    <div><span className="text-gray-500">Avg Alarms:</span> {variant.avgAlarms.toFixed(1)}</div>
                                                    <div><span className="text-gray-500">Avg Actions:</span> {variant.avgActions.toFixed(1)}</div>
                                                </div>
                                                {variant.variant.includes('*') && (
                                                    <div className="mt-2 text-xs text-orange-600">
                                                        <i className="fas fa-exclamation-triangle mr-1"></i>
                                                        Contains deviations from main process
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        <div className="flex justify-between items-center mt-4">
                                            <button
                                                onClick={() => setVariantPage(Math.max(0, variantPage - 1))}
                                                disabled={variantPage === 0}
                                                className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50"
                                            >
                                                Previous
                                            </button>
                                            <span className="text-sm text-gray-600">
                                                Page {variantPage + 1} of {Math.ceil(processVariants.length / ITEMS_PER_PAGE)}
                                            </span>
                                            <button
                                                onClick={() => setVariantPage(Math.min(Math.ceil(processVariants.length / ITEMS_PER_PAGE) - 1, variantPage + 1))}
                                                disabled={(variantPage + 1) * ITEMS_PER_PAGE >= processVariants.length}
                                                className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'sessions' && (
                                    <div className="card">
                                        <div className="mb-4">
                                            <h2 className="text-2xl font-bold">Session Browser</h2>
                                        </div>

                                        {/* Session Filters */}
                                        <div className="filter-section mb-4">
                                            <h4 className="font-semibold mb-3">Session Filters</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">{unitColumnLabel}</label>
                                                    <select
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={sessionFilters.unit}
                                                        onChange={(e) => {
                                                            setSessionFilters(prev => ({ ...prev, unit: e.target.value }));
                                                            setSessionPage(0); // Reset pagination
                                                        }}
                                                    >
                                                        <option value="all">All {unitColumnLabelPlural}</option>
                                                        {uniqueUnits.map(unit => (
                                                            <option key={unit} value={unit}>{unit}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Min Duration (minutes)</label>
                                                    <input
                                                        type="number"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={sessionFilters.minDuration}
                                                        onChange={(e) => {
                                                            setSessionFilters(prev => ({ ...prev, minDuration: parseInt(e.target.value) || 0 }));
                                                            setSessionPage(0);
                                                        }}
                                                        min="0"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Min Alarms</label>
                                                    <input
                                                        type="number"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        value={sessionFilters.minAlarms}
                                                        onChange={(e) => {
                                                            setSessionFilters(prev => ({ ...prev, minAlarms: parseInt(e.target.value) || 0 }));
                                                            setSessionPage(0);
                                                        }}
                                                        min="0"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">Contains Alarm Tag</label>
                                                    <input
                                                        type="text"
                                                        className="w-full px-3 py-2 border rounded-md"
                                                        placeholder="e.g., LC5201 (raw tag)"
                                                        value={sessionFilters.containsAlarm}
                                                        onChange={(e) => {
                                                            setSessionFilters(prev => ({ ...prev, containsAlarm: e.target.value }));
                                                            setSessionPage(0);
                                                        }}
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <p className="text-sm text-gray-600 mb-4">
                                            Showing {filteredSessions.length} sessions. Click on any session to analyze in Process Mining
                                        </p>

                                        {filteredSessions.slice(sessionPage * ITEMS_PER_PAGE, (sessionPage + 1) * ITEMS_PER_PAGE).map(session => (
                                            <div key={session.id} className="session-item mb-2 border-l-4 border-blue-500">
                                                <div className="flex justify-between items-start mb-2">
                                                    <h4 className="font-medium">Session #{session.id} - {unitColumnLabel}: {session.unit}</h4>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => analyzeSessionInChat(session)}
                                                            className="text-xs px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700"
                                                            title="Analyze with AI Assistant"
                                                        >
                                                            <i className="fas fa-comments mr-1"></i>AI Analysis
                                                        </button>
                                                        <button
                                                            onClick={() => showSessionInProcessMining(session)}
                                                            className="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                                                            title="View in Process Mining"
                                                        >
                                                            <i className="fas fa-project-diagram mr-1"></i>Process View
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="text-sm text-gray-500 mb-2">
                                                    {moment(session.startTime).format('MMM DD, HH:mm:ss')} - {moment(session.endTime).format('HH:mm:ss')}
                                                </div>
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-2">
                                                    <div><span className="text-gray-500">Duration:</span> {moment.duration(session.duration).humanize()}</div>
                                                    <div><span className="text-gray-500">Events:</span> {session.events.length}</div>
                                                    <div><span className="text-gray-500">Alarms:</span> <span className={session.alarmFrequency > 10 ? 'text-red-600 font-semibold' : ''}>{session.alarms}</span></div>
                                                    <div><span className="text-gray-500">Actions:</span> {session.actions}</div>
                                                </div>
                                                <div className="mt-2 text-xs text-gray-600">
                                                    <span className="font-medium">Sequence:</span> {session.events.slice(0, 5).map(e => e.tag).join(' â†’ ')}
                                                    {session.events.length > 5 && '...'}
                                                </div>
                                                {session.eventDescriptions.length > 0 && (
                                                    <div className="mt-2 p-2 bg-gray-50 rounded text-xs">
                                                        <span className="font-medium text-gray-700">Alarm Descriptions:</span>
                                                        {session.eventDescriptions.slice(0, 2).map((desc, i) => (
                                                            <div key={i} className="text-gray-600 mt-1">
                                                                <span className="font-medium">{desc.tag}:</span> {desc.desc1 || desc.desc2}
                                                            </div>
                                                        ))}
                                                        {session.eventDescriptions.length > 2 && <span className="text-gray-500">...and {session.eventDescriptions.length - 2} more</span>}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        <div className="flex justify-between items-center mt-4">
                                            <button
                                                onClick={() => setSessionPage(Math.max(0, sessionPage - 1))}
                                                disabled={sessionPage === 0}
                                                className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50"
                                            >
                                                Previous
                                            </button>
                                            <span className="text-sm text-gray-600">
                                                Page {sessionPage + 1} of {Math.ceil(filteredSessions.length / ITEMS_PER_PAGE)}
                                            </span>
                                            <button
                                                onClick={() => setSessionPage(Math.min(Math.ceil(filteredSessions.length / ITEMS_PER_PAGE) - 1, sessionPage + 1))}
                                                disabled={(sessionPage + 1) * ITEMS_PER_PAGE >= filteredSessions.length}
                                                className="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50"
                                            >
                                                Next
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'prediction' && (
                                    <div>
                                        <div className="tab-header">
                                            <h2 className="text-2xl font-bold">AI-Powered Prediction & Response</h2>
                                        </div>
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                            <div className="card">
                                                <h3 className="text-lg font-semibold mb-4">Predict Next Event</h3>
                                                <p className="text-sm text-gray-600 mb-4">Enter a sequence of alarm tags to predict likely next events and optimal responses</p>
                                                <div className="flex items-center space-x-2">
                                                    <input
                                                        type="text"
                                                        value={queryInput}
                                                        onChange={(e) => setQueryInput(e.target.value)}
                                                        className="w-full mt-1 px-3 py-2 border rounded-md"
                                                        placeholder="e.g., LC5201,HS4201"
                                                    />
                                                    <button
                                                        onClick={handlePredictEvents}
                                                        disabled={!model || modelStatus !== 'trained'}
                                                        className="self-end bg-purple-600 text-white px-4 py-2 rounded-md font-medium hover:bg-purple-700 disabled:bg-gray-400"
                                                    >
                                                        Predict
                                                    </button>
                                                </div>
                                                <div className={`mt-2 text-sm ${modelStatus === 'trained' ? 'text-green-600' : 'text-gray-500'}`}>
                                                    Model Status: <span className={`model-status ${modelStatus}`}>{modelStatus}</span>
                                                </div>
                                            </div>
                                            {predictionResults && (
                                                <div className="card">
                                                    <h3 className="text-lg font-semibold mb-4">Analysis Results for "{queryInput}"</h3>

                                                    {predictionResults.sequenceHint && (
                                                        <div className="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4">
                                                            <p className="text-sm text-yellow-800">{predictionResults.sequenceHint}</p>
                                                        </div>
                                                    )}

                                                    <div className="mb-6">
                                                        <h4 className="font-semibold text-gray-700 mb-2">ML Model Predictions</h4>
                                                        {predictionResults.mlPrediction && predictionResults.mlPrediction.length > 0 ? (
                                                            <div className="space-y-2">
                                                                {predictionResults.mlPrediction.map((pred, idx) => (
                                                                    <div key={idx} className="flex justify-between items-center p-2 bg-purple-50 rounded">
                                                                        <span className="font-medium">{pred.tag}</span>
                                                                        <span className="text-sm text-purple-600">{(pred.probability * 100).toFixed(1)}%</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-gray-500">No predictions available</p>
                                                        )}
                                                    </div>

                                                    <div className="mb-6">
                                                        <h4 className="font-semibold text-gray-700 mb-2">Common Operator Responses</h4>
                                                        {predictionResults.commonResponse && predictionResults.commonResponse.length > 0 ? (
                                                            <div className="space-y-2">
                                                                {predictionResults.commonResponse.map((resp, idx) => (
                                                                    <div key={idx} className="response-recommendation">
                                                                        <div className="flex justify-between items-center">
                                                                            <span className="font-medium">{resp.tag}</span>
                                                                            <span className="text-sm text-gray-600">{resp.count} times</span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-gray-500">No common responses found</p>
                                                        )}
                                                    </div>

                                                    <div>
                                                        <h4 className="font-semibold text-gray-700 mb-2">Optimal Historical Responses</h4>
                                                        {predictionResults.optimalResponse && predictionResults.optimalResponse.length > 0 ? (
                                                            <div className="space-y-2">
                                                                {predictionResults.optimalResponse.map((resp, idx) => (
                                                                    <div key={idx} className={`response-recommendation ${idx === 0 ? 'best' : ''}`}>
                                                                        <div className="flex justify-between items-start mb-1">
                                                                            <span className="font-medium">{resp.actions.join(' â†’ ')}</span>
                                                                            {idx === 0 && <span className="text-xs bg-green-500 text-white px-2 py-1 rounded">BEST</span>}
                                                                        </div>
                                                                        <div className="text-xs text-gray-600">
                                                                            Avg Resolution: {moment.duration(resp.avgResolutionTime).humanize()} |
                                                                            Score: {(resp.avgScore * 100).toFixed(0)}% |
                                                                            Used {resp.occurrences} times
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-sm text-gray-500">No optimal responses found</p>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'assistant' && (
                                    <div>
                                        <div className="tab-header">
                                            <h2 className="text-2xl font-bold">AI Alarm Assistant</h2>
                                        </div>

                                        {/* Chatbot is always configured - backend handles API */}
                                        {(
                                            <div className="card p-0 h-[calc(100vh-300px)]">
                                                <div className="chat-container">
                                                    {/* Chat Header with Clear Button */}
                                                    <div className="flex items-center justify-between p-4 border-b">
                                                        <h3 className="font-semibold">AI Assistant Chat</h3>
                                                        <button
                                                            onClick={handleClearChat}
                                                            className="text-sm px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors"
                                                            title="Clear chat history"
                                                        >
                                                            <i className="fas fa-broom mr-1"></i>
                                                            Clear Chat
                                                        </button>
                                                    </div>

                                                    {/* Chat Messages */}
                                                    <div className="chat-messages">
                                                        {chatMessages.map((message) => (
                                                            <div key={message.id} className={`chat-message ${message.role}`}>

                                                                {/* Show Thought Process Component if thoughts exist */}
                                                                {message.thoughts && <ThoughtProcess thoughts={message.thoughts} />}

                                                                <div className="chat-message-content">
                                                                    {message.role === 'assistant' && (
                                                                        <div className="flex items-center gap-2 mb-2">
                                                                            <i className="fas fa-robot text-purple-600"></i>
                                                                            <span className="text-xs text-gray-500">AI Assistant</span>
                                                                        </div>
                                                                    )}
                                                                    <div
                                                                        dangerouslySetInnerHTML={{ __html: message.content }}
                                                                    />
                                                                    <div className="text-xs text-gray-400 mt-2">
                                                                        {moment(message.timestamp).format('HH:mm:ss')}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {isTyping && (
                                                            <div className="chat-message assistant">
                                                                <div className="typing-indicator">
                                                                    <span></span>
                                                                    <span></span>
                                                                    <span></span>
                                                                </div>
                                                            </div>
                                                        )}
                                                        <div ref={chatMessagesEndRef} />
                                                    </div>

                                                    {/* Suggestions */}
                                                    {sessions.length > 0 && (
                                                        <div className="chat-suggestions">
                                                            <div className="text-xs text-gray-600 mb-2">Suggestions:</div>
                                                            <div className="flex flex-wrap gap-2">
                                                                {getChatSuggestions().map((suggestion, idx) => (
                                                                    <div
                                                                        key={idx}
                                                                        className="suggestion-chip"
                                                                        onClick={() => handleSuggestionClick(suggestion)}
                                                                    >
                                                                        {suggestion}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Chat Input */}
                                                    <div className="chat-input-container">
                                                        <form onSubmit={handleChatSubmit} className="flex gap-2">
                                                            <input
                                                                type="text"
                                                                value={chatInput}
                                                                onChange={(e) => setChatInput(e.target.value)}
                                                                placeholder="Ask about alarms, patterns, or recommendations..."
                                                                className="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                                disabled={isTyping}
                                                            />
                                                            <button
                                                                type="submit"
                                                                disabled={isTyping || !chatInput.trim()}
                                                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                                            >
                                                                <i className="fas fa-paper-plane"></i>
                                                            </button>
                                                        </form>

                                                        {selectedChatSession && (
                                                            <div className="mt-2 p-2 bg-blue-50 rounded text-xs">
                                                                <span className="text-blue-700">
                                                                    <i className="fas fa-info-circle mr-1"></i>
                                                                    Analyzing Session #{selectedChatSession.id}
                                                                </span>
                                                                <button
                                                                    onClick={() => setSelectedChatSession(null)}
                                                                    className="ml-2 text-blue-600 hover:text-blue-800"
                                                                >
                                                                    Clear
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    {/* Settings Modal - Moved to end for correct stacking context */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full z-[60] flex items-center justify-center">
                            <div className="relative w-full max-w-lg mx-4 p-6 rounded-lg shadow-xl" style={{ backgroundColor: 'var(--bg-card)', border: '1px solid var(--border-color)' }}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>
                                        <i className="fas fa-cog mr-2"></i>Settings
                                    </h2>
                                    <button onClick={() => setShowSettings(false)} className="text-gray-400 hover:text-gray-600">
                                        <i className="fas fa-times text-xl"></i>
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    {/* General Chat Model */}
                                    <div>
                                        <label className="block text-sm font-medium mb-1" style={{ color: 'var(--text-secondary)' }}>
                                            <i className="fas fa-comments mr-1"></i>General Chat Model
                                        </label>
                                        <input
                                            type="text"
                                            value={chatbotSettings.generalDeploymentName}
                                            onChange={(e) => setChatbotSettings({ ...chatbotSettings, generalDeploymentName: e.target.value })}
                                            className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500"
                                            style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' }}
                                            placeholder="gpt-4.1, gpt-4o, etc."
                                        />
                                        <p className="text-xs mt-1" style={{ color: 'var(--text-muted)' }}>
                                            Used for AI Assistant chat
                                        </p>
                                    </div>

                                    {/* D&R Reasoning Model */}
                                    <div className="p-3 rounded-lg border-2 border-purple-500 bg-purple-50 dark:bg-purple-900/20">
                                        <label className="block text-sm font-medium mb-1 text-purple-700 dark:text-purple-300">
                                            <i className="fas fa-brain mr-1"></i>D&R Reasoning Model
                                        </label>
                                        <input
                                            type="text"
                                            value={chatbotSettings.drDeploymentName}
                                            onChange={(e) => setChatbotSettings({ ...chatbotSettings, drDeploymentName: e.target.value })}
                                            className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-purple-500"
                                            style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' }}
                                            placeholder="gpt-5, o1, o3, o4-mini, etc."
                                        />
                                        <p className="text-xs mt-1 text-purple-600 dark:text-purple-400">
                                            Used for AI Rationalization workflows (supports reasoning models)
                                        </p>
                                    </div>

                                    {/* Reasoning Effort (conditional) */}
                                    {isReasoningModel() && (
                                        <div className="p-3 rounded-lg border-2 border-blue-500 bg-blue-50 dark:bg-blue-900/20">
                                            <label className="block text-sm font-medium mb-1 text-blue-700 dark:text-blue-300">
                                                <i className="fas fa-brain mr-1"></i>Reasoning Effort
                                            </label>
                                            <select
                                                value={chatbotSettings.reasoningEffort}
                                                onChange={(e) => setChatbotSettings({ ...chatbotSettings, reasoningEffort: e.target.value })}
                                                className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500"
                                                style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' }}
                                            >
                                                <option value="low">Low - Quick, less thinking</option>
                                                <option value="medium">Medium - Balanced (Default)</option>
                                                <option value="high">High - Deeper reasoning</option>
                                                <option value="xhigh">Extra High - Maximum reasoning</option>
                                            </select>
                                            <p className="text-xs mt-1 text-blue-600 dark:text-blue-400">
                                                Controls how much the model "thinks" before responding
                                            </p>
                                        </div>
                                    )}

                                    {/* API Version */}
                                    <div>
                                        <label className="block text-sm font-medium mb-1" style={{ color: 'var(--text-secondary)' }}>API Version</label>
                                        <input
                                            type="text"
                                            value={chatbotSettings.apiVersion}
                                            onChange={(e) => setChatbotSettings({ ...chatbotSettings, apiVersion: e.target.value })}
                                            className="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-blue-500"
                                            style={{ backgroundColor: 'var(--bg-secondary)', borderColor: 'var(--border-color)', color: 'var(--text-primary)' }}
                                        />
                                    </div>
                                </div>

                                <div className="flex justify-end gap-3 mt-6 pt-4 border-t" style={{ borderColor: 'var(--border-color)' }}>
                                    <button
                                        onClick={() => setShowSettings(false)}
                                        className="px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700"
                                        style={{ color: 'var(--text-secondary)' }}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => {
                                            saveChatbotSettings();
                                            setShowSettings(false);
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        <i className="fas fa-save mr-2"></i>Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<AlarmAnalyzerApp />, document.getElementById('root'));
    </script>
</body>

</html>